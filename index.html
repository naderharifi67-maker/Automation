<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãÏíÑíÊ Óåãíå ãåäÏÓÇä äÞÔå ÈÑÏÇÑ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font (for better Persian display via browser fallback) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Tahoma, Arial, sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .modal-container {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        /* Style to hide non-active views */
        .view-container {
            min-height: 400px; /* Ensure content doesn't jump */
        }
        .hidden-view {
            display: none;
        }
        /* Print Styles: Critical for clean printouts */
        @media print {
            /* Hide elements not needed in print */
            .print\:hidden, .modal-container:not(#printReportModal), .card, .gradient-bg, .footer-buttons {
                display: none !important;
            }
            body, html {
                margin: 0;
                padding: 0;
                background: white;
                color: black;
            }
            #printReportModal {
                display: flex !important;
                position: static;
                background: white !important;
                height: auto;
                width: 100%;
                max-width: none;
            }
            #reportContentContainer {
                max-width: 100%;
                width: 100%;
                height: auto;
                box-shadow: none;
                padding: 0;
                border: none;
            }
            #printReportArea {
                overflow: visible !important;
                padding: 0;
            }
            .report-table thead, .report-table tfoot {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .report-table thead th {
                background-color: #dbeafe !important;
            }
            .report-table tfoot td {
                background-color: #f3f4f6 !important;
            }
            .report-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
                border: 1px solid #ccc;
            }
            .report-table th, .report-table td {
                border: 1px solid #ccc;
                padding: 6px;
                text-align: right;
            }
            /* Show content that was hidden in view */
            .print-only {
                display: block !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="gradient-bg text-white p-6 rounded-xl mb-8 card print:hidden">
            <h1 class="text-3xl font-bold mb-2">ÓÇãÇäå ÇÑÌÇÚ ˜ÇÑ ãåäÏÓÇä äÞÔå ÈÑÏÇÑ</h1>
            <p class="text-sm opacity-90">ãÏíÑíÊ Óåãíå ÇÚÊÈÇÑí æ ÇÑÌÇÚ ÑæŽååÇ ÈÑ ÇÓÇÓ Çíå ãåäÏÓí æ ãÏíÑíÊ ÈÏåí.</p>
        </header>

        <!-- Global Message/Error Box -->
        <div id="messageBox" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center" role="alert"></div>

        <!-- Main Button Navigation -->
        <div class="flex flex-wrap justify-center gap-4 mb-8 print:hidden">
            <button onclick="showView('addEngineerModal')"
                    class="bg-green-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                ËÈÊ ãåäÏÓ ÌÏíÏ
            </button>
            <button onclick="showView('assignProjectModal')"
                    class="bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                ÇÑÌÇÚ ˜ÇÑ ÌÏíÏ
            </button>
            <button onclick="showView('dashboardView')"
                    class="bg-gray-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-gray-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                ÏÇÔÈæÑÏ ãåäÏÓíä
            </button>
            <button onclick="showMonthlyReport()"
                    class="bg-purple-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-purple-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                ÂãÇÑ ãÇåíÇäå
            </button>
        </div>

        <!-- Dynamic Content Area -->
        <div id="contentArea" class="view-container">

            <!-- 1. ËÈÊ ãåäÏÓ ÌÏíÏ Modal (ÊÈÏíá Èå View/Form) -->
            <div id="addEngineerModal" class="bg-white p-6 rounded-xl card hidden-view">
                <h3 class="text-2xl font-bold text-green-700 border-b pb-3 mb-4">ËÈÊ ãåäÏÓ ÌÏíÏ</h3>
                <form id="addEngineerForm" class="space-y-4 max-w-lg mx-auto">
                    <div>
                        <label for="engineerName" class="block text-sm font-medium text-gray-700 mb-1">äÇã æ äÇã ÎÇäæÇÏí ãåäÏÓ:</label>
                        <input type="text" id="engineerName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="ãËáÇð: Úáí ãÍãÏí">
                    </div>
                    <div>
                        <label for="engineerRank" class="block text-sm font-medium text-gray-700 mb-1">Çíå ãåäÏÓí:</label>
                        <select id="engineerRank" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            <option value="" disabled selected>ÇäÊÎÇÈ Çíå...</option>
                            <option value="Çíå Óå">Çíå Óå (ÓÞÝ ?? ã.Ê)</option>
                            <option value="Çíå Ïæ">Çíå Ïæ (ÓÞÝ ?? ã.Ê)</option>
                            <option value="Çíå í˜">Çíå í˜ (ÓÞÝ ?? ã.Ê)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition duration-150 shadow-md">ÐÎíÑå ãåäÏÓ</button>
                </form>
            </div>


            <!-- 2. ÇÑÌÇÚ ˜ÇÑ ÌÏíÏ Modal (ÊÈÏíá Èå View/Form) -->
            <div id="assignProjectModal" class="bg-white p-6 rounded-xl card hidden-view">
                <h3 class="text-2xl font-bold text-blue-800 border-b pb-3 mb-4">ÇÑÌÇÚ ˜ÇÑ ÌÏíÏ</h3>
                <form id="assignProjectForm" class="space-y-5 max-w-lg mx-auto">
                    <!-- Job Type Selection -->
                    <div>
                        <label for="jobType" class="block text-sm font-medium text-gray-700 mb-1">äæÚ ˜ÇÑ / äÞÔå:</label>
                        <select id="jobType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>ÇäÊÎÇÈ äæÚ ˜ÇÑ...</option>
                            <!-- Options will be populated by JS based on PROJECT_COSTS -->
                        </select>
                    </div>

                    <!-- Dynamic Inputs Container (ãÊÑÇŽ¡ ÇÑÇä¡ åÒíäå ÏÓÊí) -->
                    <div id="dynamicInputs" class="space-y-4 p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 text-center">áØÝÇð äæÚ ˜ÇÑ ÑÇ ÇäÊÎÇÈ ˜äíÏ ÊÇ ÌÒÆíÇÊ ÑæŽå ãÔÎÕ ÔæÏ.</p>
                    </div>
                    
                    <!-- Client Name -->
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">äÇã ãÊÞÇÖí Êåíå äÞÔå:</label>
                        <input type="text" id="clientName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ãËáÇð: ÔÑ˜Ê ÊæÓÚå ÔåÑ">
                    </div>

                    <div id="assignmentResult" class="p-4 border-r-4 rounded-lg text-gray-800 hidden">
                        <h3 class="font-bold text-lg mb-2">äÊíÌå ÇÑÌÇÚ ˜ÇÑ:</h3>
                        <p id="resultText"></p>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 shadow-md">ÇÑÌÇÚ ˜ÇÑ æ ãÚÑÝí ãåäÏÓ</button>
                </form>
            </div>


            <!-- 3. ÏÇÔÈæÑÏ ãåäÏÓíä View -->
            <div id="dashboardView" class="bg-white p-6 rounded-xl card hidden-view">
                <h2 class="text-2xl font-semibold border-b pb-3 mb-4 text-gray-800">ÏÇÔÈæÑÏ Óåãíå ãåäÏÓíä (ãíáíæä ÊæãÇä)</h2>

                <div class="text-center p-4 text-gray-500" id="loadingMessage">ÏÑ ÍÇá ÈÇÑÐÇÑí ÇØáÇÚÇÊ ãåäÏÓÇä...</div>
                <div id="engineerList" class="space-y-4">
                    <!-- Engineer list will be dynamically inserted here -->
                </div>

                <!-- Global Quota Reset Button Container -->
                <div id="newQuotaButtonContainer" class="mt-8 pt-4 border-t flex justify-center hidden">
                    <button onclick="resetAllEngineersQuotas()" class="bg-red-700 text-white p-3 text-lg rounded-lg hover:bg-red-800 transition duration-150 shadow-2xl flex items-center font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v2M2 12A10 10 0 0 1 12 2a10 10 0 0 1 10 10M8 12l4 4 4-4" /></svg>
                        ÈÇÒ ˜ÑÏä Óåãíå ÌÏíÏ ÈÑÇí åãå ãåäÏÓÇä (ÊÓæíå ÈÏåí)
                    </button>
                </div>
                
                <!-- Removed old print report button here. The new Monthly Report button handles comprehensive reporting. -->

            </div>

        </div> <!-- End of contentArea -->
        
    </div>


    <!-- Engineer Details Modal (áíÓÊ ˜ÇÑåÇí ÇÑÌÇÚí ÈÑÇí ãåäÏÓ ÎÇÕ) -->
    <div id="detailsModal" class="modal-container hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card max-w-2xl w-full p-6" role="dialog" aria-modal="true">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 id="modalTitle" class="text-xl md:text-2xl font-bold text-blue-800">ÌÒÆíÇÊ ˜ÇÑåÇ</h3>
                <button onclick="closeModal('detailsModal')" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="projectsList" class="max-h-96 overflow-y-auto space-y-3">
                <div class="text-center p-4 text-gray-500" id="modalLoadingMessage">ÏÑ ÍÇá ÈÇÑÐÇÑí ÌÒÆíÇÊ ˜ÇÑåÇ...</div>
            </div>

            <div class="mt-6 border-t pt-4 text-left">
                <button onclick="closeModal('detailsModal')" class="bg-blue-600 text-white p-2 px-4 rounded-lg hover:bg-blue-700 transition">ÈÓÊä</button>
            </div>
        </div>
    </div>

    <!-- Monthly Report/Print Modal (Used for Monthly Statistics) -->
    <div id="printReportModal" class="modal-container hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div id="reportContentContainer" class="bg-white rounded-xl card max-w-6xl w-full p-6 h-[90vh] flex flex-col" role="dialog" aria-modal="true">
            <div class="flex justify-between items-start border-b pb-3 mb-4 flex-shrink-0 print:hidden">
                <h3 class="text-2xl font-bold text-gray-800">ÒÇÑÔ ÌÇãÚ ãÇåíÇäå ÇÑÌÇÚÇÊ ˜ÇÑ</h3>
                <button onclick="closeModal('printReportModal')" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="printReportArea" class="flex-grow overflow-y-auto p-2">
                <div class="text-center p-8 text-gray-500">ÏÑ ÍÇá ÂãÇÏåÓÇÒí ÒÇÑÔ...</div>
            </div>

            <div class="mt-4 border-t pt-4 flex justify-end gap-3 flex-shrink-0 footer-buttons print:hidden">
                <button onclick="window.printReport()" class="bg-green-600 text-white p-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H3v6h2v3h10v-3h2V7h-2V4h-3V3H8v1H5zm0 1h2v2H5V5zm10 0v2h-2V5h2zM5 14v-2h10v2H5zm10 2v-2h-2v2h2zM5 16h2v-2H5v2z" clip-rule="evenodd"/></svg>
                    Ç ÒÇÑÔ
                </button>
                <button onclick="closeModal('printReportModal')" class="bg-gray-500 text-white p-2 px-4 rounded-lg hover:bg-gray-600 transition">ÈÓÊä</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal (Generic) -->
    <div id="confirmationModal" class="modal-container hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card max-w-sm w-full p-6" role="alertdialog" aria-modal="true">
            <h3 id="confirmModalTitle" class="text-xl font-bold text-red-700 border-b pb-2 mb-4">ÊÇííÏ ÚãáíÇÊ</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancelBtn" onclick="closeModal('confirmationModal')" class="bg-gray-300 text-gray-800 p-2 px-4 rounded-lg hover:bg-gray-400 transition">ÇäÕÑÇÝ</button>
                <button id="confirmAcceptBtn" class="bg-red-600 text-white p-2 px-4 rounded-lg hover:bg-red-700 transition">ÊÇííÏ æ ÇÌÑÇ</button>
            </div>
        </div>
    </div>


    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, runTransaction, query, where, getDocs, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ÊäÙíãÇÊ ÓÑÇÓÑí ÝÇíÑÈíÓ
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;
        
        // --- Static Data ---

        // ãÈÇáÛ íÔÝÑÖ ÈÑÇí ÇäæÇÚ ˜ÇÑ (Èå æÇÍÏ ãíáíæä ÊæãÇä)
        const PROJECT_COSTS = {
            'äÞÔå ˜Ñæ˜í': 1,
            'äÞÔå Ê˜ ÎØí': 2,
            'äÞÔå íæ Êí Çã': 4, 
        };
        
        // ÇØáÇÚÇÊ ˜Çãá ÈÑÇí ãÏíÑíÊ ÝíáÏåÇí ãÊÛíÑ
        const JOB_DETAILS = {
            'äÞÔå ˜Ñæ˜í': { label: 'ãÊÑÇŽ Òãíä (ãÊÑ ãÑÈÚ):', isAreaRequired: true, organization: 'ÔåÑÏÇÑí' },
            'äÞÔå Ê˜ ÎØí': { label: 'ãÊÑÇŽ ˜á ÒíÑ ÈäÇ (ãÊÑ ãÑÈÚ):', isAreaRequired: true, organization: 'ÔåÑÏÇÑí' },
            'äÞÔå íæ Êí Çã': { label: 'ãÊÑÇŽ Òãíä (ãÊÑ ãÑÈÚ):', isAreaRequired: true, organization: 'ÇäÊÎÇÈ ÇÑÇä' }, 
        };


        // ÓÞÝ Óåãíå ÈÑ ÇÓÇÓ Çíå (Èå æÇÍÏ ãíáíæä ÊæãÇä)
        const RANK_QUOTAS = {
            'Çíå Óå': 10,
            'Çíå Ïæ': 15,
            'Çíå í˜': 20,
        };
        
        // ÇæáæíÊ ÚÏÏí Çíå ãåäÏÓí ÈÑÇí ãÑÊÈÓÇÒí (ÈíÔÊÑ = ÇæáæíÊ ÈÇáÇÊÑ)
        const RANK_PRIORITY = {
            'Çíå í˜': 3,
            'Çíå Ïæ': 2,
            'Çíå Óå': 1,
        };

        // ÇÑÇäåÇí ãÑÈæØå ÈÑÇí äÞÔååÇí UTM
        const UTM_ORGANIZATIONS = [
            'ÇæÞÇÝ æ ÇãæÑÎíÑíå',
            'ÈäíÇÏ ãÓ˜ä',
            'ÌåÇÏ ˜ÔÇæÑÒí',
            'ãäÇÈÚ ØÈíÚí',
            'ÇÏÇÑå ËÈÊ ÇÓäÇÏ æ ÇãáÇ˜',
            'ãíÑÇË ÝÑåäí',
            'ÔåÑÏÇÑí' 
        ];
        
        
        // ãÓíÑåÇí ÝÇíÑÈíÓ
        let ENGINEER_COLLECTION, PROJECTS_COLLECTION;
        let allEngineersMap = {}; // Cache for engineer details

        // ãÑÌÚ ÚäÇÕÑ Modal
        let detailsModalRef, modalTitleRef, projectsListRef, modalLoadingMessageRef;

        // --- Utility Functions ---
        
        // Modal Open/Close Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // ÊÇÈÚ äãÇíÔ æ ãÎÝí ˜ÑÏä æíæåÇ
        function showView(viewId) {
            const views = ['addEngineerModal', 'assignProjectModal', 'dashboardView'];
            views.forEach(id => {
                const view = document.getElementById(id);
                if (view) {
                    if (id === viewId) {
                        view.classList.remove('hidden-view');
                    } else {
                        view.classList.add('hidden-view');
                    }
                }
            });

            // ÇÑ äãÇí íÔ ÝÑÖ ÏÇÔÈæÑÏ ÈæÏ¡ ÈÚÏ ÇÒ äãÇíÔ¡ ãØãÆä Ôæíã ˜å áíÓÊ ãåäÏÓÇä äíÒ Scroll ÔæÏ.
            if (viewId === 'dashboardView') {
                document.getElementById('dashboardView').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        window.closeModal = closeModal;
        window.showView = showView; // Expose to global scope for button clicks

        // --- Custom Confirmation Modal Logic ---
        let confirmCallback = null;

        function showConfirmationModal(title, message, callback) {
            const modal = document.getElementById('confirmationModal');
            const titleEl = document.getElementById('confirmModalTitle');
            const messageEl = document.getElementById('confirmModalMessage');
            const acceptBtn = document.getElementById('confirmAcceptBtn');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.remove('hidden');
            
            confirmCallback = callback;

            // Remove old listeners and add the new one
            // This clone/replace technique prevents multiple event listeners from stacking up
            const newAcceptBtn = acceptBtn.cloneNode(true);
            acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);

            newAcceptBtn.addEventListener('click', () => {
                closeModal('confirmationModal');
                if (confirmCallback) {
                    confirmCallback(true);
                }
            });

            document.getElementById('confirmCancelBtn').onclick = () => {
                closeModal('confirmationModal');
                // We don't call the callback with false, as the default is just to stop the action.
            };
        }
        window.showConfirmationModal = showConfirmationModal;


        // ÊÇÈÚ äãÇíÔ íÇã Èå ˜ÇÑÈÑ
        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;

            let bgColor, borderColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    borderColor = 'border-green-600';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    borderColor = 'border-red-600';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-100';
                    borderColor = 'border-blue-600';
                    break;
            }

            box.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center border-l-8 ${bgColor} ${borderColor}`;
            box.classList.remove('hidden');

            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        // ÊÇÈÚ ÈÑÑÓí æÖÚíÊ Óåãíå ˜áí (ÂíÇ åãå Ñ åÓÊäÏ¿)
        function checkGlobalQuotaStatus(engineers) {
            if (engineers.length === 0) return false;
            // ÇÑ ÍÊí í˜ ãåäÏÓ Óåãíå ÈÇÞíãÇäÏå ãËÈÊ ÏÇÔÊå ÈÇÔÏ¡ ÓíÓÊã Ñ äíÓÊ.
            const hasFreeQuota = engineers.some(eng => (eng.maxQuota - eng.usedQuota) > 0.1); // Small buffer for float math
            return !hasFreeQuota; // ÇÑ åí˜Ó Óåãíå ÂÒÇÏ äÏÇÑÏ¡ Ï˜ãå ÈÇíÏ ÙÇåÑ ÔæÏ (True)
        }


        // ÑäÏÑ ˜ÑÏä áíÓÊ ãåäÏÓÇä (Dashboard)
        function renderEngineers(engineers) {
            const listContainer = document.getElementById('engineerList');
            const loadingMessage = document.getElementById('loadingMessage'); 
            const newQuotaButtonContainer = document.getElementById('newQuotaButtonContainer');

            listContainer.innerHTML = '';
            if (loadingMessage) {
                loadingMessage.classList.add('hidden');
            }

            if (engineers.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">åäæÒ åí ãåäÏÓí ËÈÊ äÔÏå ÇÓÊ.</p>';
                // ÇÑ ãåäÏÓí äíÓÊ¡ Ï˜ãå Óåãíå ÌÏíÏ åã áÇÒã äíÓÊ
                newQuotaButtonContainer.classList.add('hidden'); 
                return;
            }

            // ãÑÊÈ ÓÇÒí ÈÑ ÇÓÇÓ ÇæáæíÊ ÌÏíÏ: Çíå ÈÇáÇÊÑ + ÈíÔÊÑíä Óåãíå ÈÇÞíãÇäÏå (ÍÊí ãäÝí)
            const sortedEngineers = engineers.sort((a, b) => {
                const rankA = RANK_PRIORITY[a.rank] || 0;
                const rankB = RANK_PRIORITY[b.rank] || 0;
                if (rankB !== rankA) {
                    return rankB - rankA; // Higher rank first
                }
                const remainingA = a.maxQuota - a.usedQuota;
                const remainingB = b.maxQuota - b.usedQuota;
                return remainingB - remainingA; // Higher remaining first (least debt)
            });


            sortedEngineers.forEach(eng => {
                const remaining = eng.maxQuota - eng.usedQuota;
                const debt = Math.max(0, -remaining); 
                const percentageUsed = (eng.usedQuota / eng.maxQuota) * 100;

                let quotaStatusHTML;
                let progressColor;
                
                if (remaining >= 0) {
                    quotaStatusHTML = `<p class="text-md font-semibold ${remaining > 0 ? 'text-green-700' : 'text-yellow-700'} mt-1">
                                        Óåãíå ÈÇÞíãÇäÏå: ${remaining.toLocaleString('fa')} ã.Ê
                                      </p>`;
                    progressColor = percentageUsed < 95 ? 'bg-green-500' : 'bg-yellow-500';
                } else {
                    quotaStatusHTML = `<p class="text-md font-bold text-red-700 mt-1">
                                        ÈÏåí Óåãíå (ãÇÒÇÏ): ${debt.toLocaleString('fa')} ã.Ê
                                      </p>`;
                    progressColor = 'bg-red-600';
                }

                // Logic for Quota Reset Button
                let resetButtonHTML = `
                    <button onclick="event.stopPropagation(); resetEngineerQuota('${eng.id}', '${eng.fullName.replace(/'/g, "\\'")}', ${eng.usedQuota}, ${eng.maxQuota})" 
                        class="bg-blue-500 text-white px-3 py-1 text-xs rounded-lg hover:bg-blue-600 transition duration-150 mt-2 ${debt > 0 ? 'bg-red-700 hover:bg-red-800' : ''}">
                        ${debt > 0 ? 'ÊãÏíÏ æ ÊÓæíå ÈÏåí' : 'ÊãÏíÏ Óåãíå'}
                    </button>
                `;


                // ÓÇÎÊ ˜ÇÑÊ ãåäÏÓ ÈÇ ÞÇÈáíÊ ˜áí˜ ÈÑÇí ÌÒÆíÇÊ
                const engineerCard = `
                    <div class="p-4 border rounded-xl bg-gray-50 flex items-start transition hover:shadow-lg hover:border-blue-500">
                        <!-- Info (Clickable Area for Details) -->
                        <div onclick="showEngineerDetails('${eng.id}', '${eng.fullName.replace(/'/g, "\\'")}')" class="flex-grow cursor-pointer">
                            <p class="font-bold text-lg text-blue-900">${eng.fullName} (<span class="text-sm font-normal">${eng.rank}</span>)</p>
                            <div class="flex flex-wrap text-sm text-gray-600 mt-1 space-x-4 space-x-reverse">
                                <span class="font-medium">Óåãíå ˜á: ${eng.maxQuota.toLocaleString('fa')} ã.Ê</span>
                                <span>ãÕÑÝ ÔÏå: ${eng.usedQuota.toLocaleString('fa')} ã.Ê</span>
                            </div>
                            ${quotaStatusHTML}
                        </div>

                        <!-- Progress Bar & Reset Button -->
                        <div class="w-1/3 min-w-[120px] mr-4 flex flex-col items-end">
                            <div class="h-2.5 bg-gray-200 rounded-full w-full">
                                <div class="progress-bar-fill h-2.5 rounded-full ${progressColor}" style="width: ${Math.min(100, percentageUsed).toFixed(0)}%;"></div>
                            </div>
                            <p class="text-xs text-right mt-1 text-gray-500">${Math.min(100, percentageUsed).toFixed(0)}% ãÕÑÝ</p>
                            <div class="reset-button-container">
                                ${resetButtonHTML}
                            </div>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', engineerCard);
            });
            
            // äãÇíÔ/ÚÏã äãÇíÔ Ï˜ãå Óåãíå ˜áí
            const isGlobalQuotaExceeded = checkGlobalQuotaStatus(engineers);
            if (newQuotaButtonContainer) {
                if (isGlobalQuotaExceeded) {
                    newQuotaButtonContainer.classList.remove('hidden');
                } else {
                    newQuotaButtonContainer.classList.add('hidden');
                }
            }
        }
        
        // --- Dynamic Form Rendering (for Assignment View) ---
        
        function renderDynamicInputs(jobType) {
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = ''; 
            
            const jobDetail = JOB_DETAILS[jobType];
            
            if (!jobDetail) {
                 container.innerHTML = '<p class="text-sm text-gray-500 text-center">áØÝÇð äæÚ ˜ÇÑ ÑÇ ÇäÊÎÇÈ ˜äíÏ ÊÇ ÌÒÆíÇÊ ÑæŽå ãÔÎÕ ÔæÏ.</p>';
                 return;
            }

            // 1. Add Area Input if required
            if (jobDetail.isAreaRequired) {
                const areaInputHTML = `
                    <div class="area-input">
                        <label for="projectArea" class="block text-sm font-medium text-gray-700 mb-1">${jobDetail.label}</label>
                        <input type="number" step="1" min="1" id="projectArea" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ãËáÇð: ???">
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', areaInputHTML);
            }

            // 2. Add Organization Dropdown ONLY if it's 'ÇäÊÎÇÈ ÇÑÇä' (i.e., äÞÔå íæ Êí Çã)
            let relatedOrganization = jobDetail.organization;
            if (relatedOrganization === 'ÇäÊÎÇÈ ÇÑÇä') {
                let optionsHtml = UTM_ORGANIZATIONS.map(org => `<option value="${org}">${org}</option>`).join('');
                const organizationDropdown = `
                    <div class="organization-select">
                        <label for="relatedOrganization" class="block text-sm font-medium text-gray-700 mb-1">ÇÑÇä ãÑÈæØå:</label>
                        <select id="relatedOrganization" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>ÇäÊÎÇÈ ÇÑÇä...</option>
                            ${optionsHtml}
                        </select>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', organizationDropdown);
            } else if (relatedOrganization) {
                const fixedOrganizationInfo = `
                    <div class="p-2 bg-blue-50 border-l-4 border-blue-400 rounded-md text-sm text-gray-700">
                        <p class="font-semibold">ÇÑÇä ãÑÈæØå: ${relatedOrganization}</p>
                        <p class="text-xs">Çíä äæÚ äÞÔå Èå ÕæÑÊ ÎæÏ˜ÇÑ Èå ${relatedOrganization} ÇÑÌÇÚ ÏÇÏå ãíÔæÏ.</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', fixedOrganizationInfo);
            }


            // 3. Always add Manual Cost Input (Required)
            const manualCostHTML = `
                <div class="manual-cost-input">
                    <label for="manualCost" class="block text-sm font-medium text-gray-700 mb-1">åÒíäå ÈÕæÑÊ ÏÓÊí (ãíáíæä ÊæãÇä):</label>
                    <input type="number" step="0.5" min="0.5" id="manualCost" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="åÒíäå äåÇíí ÑæŽå ÑÇ æÇÑÏ ˜äíÏ (ãËáÇð: ?.?)">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', manualCostHTML);
            
            const manualCostInput = document.getElementById('manualCost');
            const defaultCost = PROJECT_COSTS[jobType];
            if (defaultCost !== undefined && manualCostInput) {
                manualCostInput.value = defaultCost;
            }
        }

        // --- Event Listeners for Dynamic Inputs ---
        
        document.getElementById('jobType').addEventListener('change', (e) => {
            const jobType = e.target.value;
            renderDynamicInputs(jobType); 
        });

        // --- Details Modal Functionality ---

        // ÊÇÈÚ äãÇíÔ ÌÒÆíÇÊ ˜ÇÑåÇí ÇÑÌÇÚ ÏÇÏå ÔÏå Èå í˜ ãåäÏÓ
        async function showEngineerDetails(engineerId, engineerName) {
            
            const modal = detailsModalRef;
            const modalTitle = modalTitleRef;
            const projectsList = projectsListRef;
            const modalLoadingMessage = modalLoadingMessageRef;
            
            if (!modal || !modalTitle || !projectsList || !modalLoadingMessage) {
                console.error("DOM Error: Cached modal elements are missing. Cannot show details.");
                showMessage("ÎØÇ: ÈÑÎí ÇÒ ÇÌÒÇí ÕÝÍå íÏÇ äÔÏäÏ. áØÝÇð ÕÝÍå ÑÇ ÑÝÑÔ ˜äíÏ.", 'error');
                return;
            }

            if (!isAuthReady || !userId) {
                showMessage("áØÝÇð ãäÊÙÑ ÈãÇäíÏ ÊÇ ÇÊÕÇá ÈÑÞÑÇÑ ÔæÏ.", 'info');
                return;
            }

            modalTitle.textContent = `ÌÒÆíÇÊ ˜ÇÑåÇ ÈÑÇí ${engineerName}`;
            projectsList.innerHTML = '';
            modalLoadingMessage.classList.remove('hidden');
            document.getElementById('detailsModal').classList.remove('hidden'); // Open the modal

            try {
                const q = query(
                    PROJECTS_COLLECTION,
                    where("assignedEngineerId", "==", engineerId)
                );
                
                const snapshot = await getDocs(q);
                
                modalLoadingMessage.classList.add('hidden');

                if (snapshot.empty) {
                    projectsList.innerHTML = '<p class="text-center text-gray-600 p-4">åí ˜ÇÑí Èå Çíä ãåäÏÓ ÇÑÌÇÚ ÏÇÏå äÔÏå ÇÓÊ.</p>';
                    return;
                }

                let projectsHtml = '';
                const sortedProjects = snapshot.docs.map(doc => doc.data()).sort((a, b) => a.timestamp - b.timestamp);

                sortedProjects.forEach(project => {
                    const date = new Date(project.timestamp).toLocaleDateString('fa-IR');
                    
                    let extraDetails = '';
                    if (project.area) {
                        const detail = JOB_DETAILS[project.jobType] || { label: 'ãÊÑÇŽ:' };
                        const areaLabel = detail.label.replace(/(\s\(.*\):|\s:)/, '').replace(':', ''); 
                        extraDetails += `<p class="text-sm text-gray-600">${areaLabel}: ${project.area.toLocaleString('fa')} ã²</p>`;
                    }
                    if (project.organization) {
                        extraDetails += `<p class="text-sm text-gray-600">ÇÑÇä: <strong>${project.organization}</strong></p>`;
                    }

                    projectsHtml += `
                        <div class="p-3 bg-gray-100 rounded-lg border-l-4 border-blue-500">
                            <p class="font-semibold text-gray-800">${project.clientName}</p>
                            <p class="text-sm text-gray-600">äæÚ ˜ÇÑ: <strong>${project.jobType}</strong></p>
                            ${extraDetails}
                            <p class="text-sm text-gray-600">åÒíäå (Óåãíå): <span class="text-blue-700 font-bold">${project.cost.toLocaleString('fa')}</span> ã.Ê</p>
                            <p class="text-xs text-gray-500 mt-1">ÊÇÑíÎ ÇÑÌÇÚ: ${date}</p>
                        </div>
                    `;
                });

                projectsList.innerHTML = projectsHtml;

            } catch (error) {
                console.error("Error fetching projects:", error);
                modalLoadingMessage.classList.add('hidden');
                projectsList.innerHTML = '<p class="text-center text-red-600 p-4">ÎØÇ ÏÑ ÈÇÑÐÇÑí ÌÒÆíÇÊ ˜ÇÑåÇ.</p>';
                showMessage("ÎØÇ ÏÑ ÈÇÑÐÇÑí ÌÒÆíÇÊ ˜ÇÑåÇ.", 'error');
            }
        }
        
        window.showEngineerDetails = showEngineerDetails;


        // ÊÇÈÚ ÇÌÑÇí ÊãÏíÏ Óåãíå ãåäÏÓ (Quota Reset) - ÈÎÔ åÓÊå
        async function executeResetEngineerQuota(engineerId, engineerName, currentUsed, maxQuota) {
            if (!isAuthReady || !userId) {
                showMessage("áØÝÇð ãäÊÙÑ ÈãÇäíÏ ÊÇ ÇÊÕÇá ÈÑÞÑÇÑ ÔæÏ.", 'info');
                return;
            }

            const engineerRef = doc(db, `artifacts/${appId}/users/${userId}/engineers`, engineerId);
            const deficit = Math.max(0, currentUsed - maxQuota);
            let message = '';
            let newUsedQuota = 0;

            if (deficit > 0) {
                newUsedQuota = deficit; // ÈÏåí ÇÒ Óåãíå ÌÏíÏ ˜ÓÑ ãíÔæÏ
                const remainingAfterDeduction = maxQuota - deficit;
                
                message = `Óåãíå ÌÏíÏ ãåäÏÓ ${engineerName} ÈÇ ãæÝÞíÊ ÊãÏíÏ ÔÏ. ãÈáÛ ${deficit.toLocaleString('fa')} ã.Ê ÈÇÈÊ ÈÏåí ÞÈáí ÇÒ Óåãíå ˜ÓÑ ÔÏ. Óåãíå ÂÒÇÏ ÈÇÞíãÇäÏå: ${Math.max(0, remainingAfterDeduction).toLocaleString('fa')} ã.Ê.`;
            } else {
                newUsedQuota = 0;
                message = `Óåãíå ãåäÏÓ ${engineerName} ÈÇ ãæÝÞíÊ ÊãÏíÏ ÔÏ æ Óåãíå ãÕÑÝí Èå ÕÝÑ ÑÓíÏ.`;
            }

            try {
                await updateDoc(engineerRef, {
                    usedQuota: newUsedQuota,
                    lastReset: Date.now()
                });
                showMessage(message, 'success');
            } catch (error) {
                console.error("Error resetting quota:", error);
                showMessage(`ÎØÇ ÏÑ ÊãÏíÏ Óåãíå: ${error.message}`, 'error');
            }
        }
        
        // ÊÇÈÚ æÇÓØ ÈÑÇí äãÇíÔ ÊÇííÏíå ÊãÏíÏ Óåãíå
        function resetEngineerQuota(engineerId, engineerName, currentUsed, maxQuota) {
            const remaining = maxQuota - currentUsed;
            const debt = Math.max(0, -remaining);
            let title = 'ÊãÏíÏ Óåãíå ãåäÏÓ';
            let message = `ÂíÇ ãÇíá Èå ÊãÏíÏ Óåãíå ãåäÏÓ ${engineerName} åÓÊíÏ¿`;

            if (debt > 0) {
                title = 'ÊÓæíå ÈÏåí æ ÊãÏíÏ Óåãíå';
                message += ` ÈÏåí ${debt.toLocaleString('fa')} ã.Ê ˜ÓÑ ÎæÇåÏ ÔÏ æ Óåãíå ÌÏíÏ ÈÇÒ ãíÔæÏ.`;
            } else {
                message += ` Óåãíå ãÕÑÝí Èå ÕÝÑ (ÂÒÇÏ) ÈÇÒ ãíÑÏÏ.`;
            }

            showConfirmationModal(title, message, (confirmed) => {
                if (confirmed) {
                    executeResetEngineerQuota(engineerId, engineerName, currentUsed, maxQuota);
                }
            });
        }
        window.resetEngineerQuota = resetEngineerQuota;


        // --- Global Reset Quota Logic ---
        
        // ÊÇÈÚ åÓÊå ÈÑÇí ÇÌÑÇí ÈÇÒ ˜ÑÏä Óåãíå ˜áí
        async function executeResetAllEngineersQuotas() {
            if (!isAuthReady || !userId) {
                showMessage("áØÝÇð ãäÊÙÑ ÈãÇäíÏ ÊÇ ÇÊÕÇá ÈÑÞÑÇÑ ÔæÏ.", 'info');
                return;
            }

            showMessage("ÏÑ ÍÇá ÈÇÒ ˜ÑÏä Óåãíå ÌÏíÏ ÈÑÇí ÊãÇãí ãåäÏÓíä...", 'info');

            try {
                const snapshot = await getDocs(query(ENGINEER_COLLECTION));
                const batch = writeBatch(db);
                const resetTime = Date.now();
                let engineersReset = 0;

                snapshot.docs.forEach(docSnapshot => {
                    const eng = docSnapshot.data();
                    const remaining = eng.maxQuota - eng.usedQuota;
                    const debt = Math.max(0, -remaining);
                    
                    // New usedQuota is the amount of debt carried over
                    const newUsedQuota = debt;

                    batch.update(docSnapshot.ref, {
                        usedQuota: newUsedQuota,
                        lastReset: resetTime
                    });
                    engineersReset++;
                });

                await batch.commit();

                showMessage(`Óåãíå ÌÏíÏ ÈÑÇí ${engineersReset.toLocaleString('fa')} ãåäÏÓ ÈÇ ãæÝÞíÊ ÈÇÒ ÔÏ. ÈÏåíåÇí ÞÈáí ãÍÇÓÈå æ ÇÚãÇá ÑÏíÏ.`, 'success');
                // Hide the button after reset (the onSnapshot listener will re-render the button state automatically too)
                document.getElementById('newQuotaButtonContainer').classList.add('hidden');

            } catch (error) {
                console.error("Error performing global quota reset:", error);
                showMessage(`ÎØÇ ÏÑ ÈÇÒ ˜ÑÏä Óåãíå: ${error.message}`, 'error');
            }
        }

        // ÊÇÈÚ æÇÓØ ÈÑÇí äãÇíÔ ÊÇííÏíå ÈÇÒ ˜ÑÏä Óåãíå ˜áí
        function resetAllEngineersQuotas() {
            const title = 'ÈÇÒ ˜ÑÏä Óåãíå ÌÏíÏ ÈÑÇí åãå';
            const message = 'ÂíÇ ÇÒ ÈÇÒ ˜ÑÏä Óåãíå ÌÏíÏ ÈÑÇí ÊãÇãí ãåäÏÓíä ãØãÆä åÓÊíÏ¿ Çíä ˜ÇÑ ÈÏåíåÇí ÞÈáí ÑÇ ãÍÇÓÈå ˜ÑÏå æ ÇÒ Óåãíå ÌÏíÏ åÑ ãåäÏÓ ˜ÓÑ ãí˜äÏ. Çíä ÚãáíÇÊ ÞÇÈá ÈÑÔÊ äíÓÊ.';

            showConfirmationModal(title, message, (confirmed) => {
                if (confirmed) {
                    executeResetAllEngineersQuotas();
                }
            });
        }
        window.resetAllEngineersQuotas = resetAllEngineersQuotas;

        // --- ÒÇÑÔ ãÇåíÇäå (Monthly Report) ---
        async function showMonthlyReport() {
            
            if (!isAuthReady || !userId) {
                showMessage("áØÝÇð ãäÊÙÑ ÈãÇäíÏ ÊÇ ÇÊÕÇá ÈÑÞÑÇÑ ÔæÏ.", 'info');
                return;
            }

            const modal = document.getElementById('printReportModal');
            const reportArea = document.getElementById('printReportArea');
            reportArea.innerHTML = '<div class="text-center p-8 text-gray-500">ÏÑ ÍÇá ÂãÇÏåÓÇÒí ÒÇÑÔ ãÇåíÇäå...</div>';
            modal.classList.remove('hidden'); 

            try {
                // 1. Fetch all projects and engineers
                const projectSnapshot = await getDocs(query(PROJECTS_COLLECTION));
                const projects = projectSnapshot.docs.map(doc => doc.data());

                const engineersMap = allEngineersMap; // Use cached map

                if (projects.length === 0) {
                    reportArea.innerHTML = '<p class="text-center text-gray-600 p-12 bg-gray-50 rounded-lg">åí ˜ÇÑ ÇÑÌÇÚí ÏÑ ÓíÓÊã ËÈÊ äÔÏå ÇÓÊ.</p>';
                    return;
                }

                // 2. Group projects by Persian Month/Year (YYYY/MM)
                const projectsByMonth = projects.reduce((acc, proj) => {
                    const date = new Date(proj.timestamp);
                    // Format: '????/??' (Persian Year/Month)
                    const persianDate = date.toLocaleDateString('fa-IR', {
                        year: 'numeric',
                        month: '2-digit',
                        calendar: 'persian'
                    });
                    // Key format: '???? / ??'
                    const monthKey = persianDate.replace(/\//g, ' / '); 

                    if (!acc[monthKey]) {
                        acc[monthKey] = {
                            totalCost: 0,
                            projectCount: 0,
                            projects: []
                        };
                    }
                    acc[monthKey].totalCost += proj.cost;
                    acc[monthKey].projectCount++;
                    acc[monthKey].projects.push(proj);
                    return acc;
                }, {});

                // 3. Sort months chronologically descending (newest first)
                const sortedMonthKeys = Object.keys(projectsByMonth).sort((a, b) => {
                    // Reverse the standard string comparison to get descending order (newest date string is "greater")
                    return b.localeCompare(a, 'fa'); 
                });

                // 4. Generate HTML Report
                let reportHtml = `
                    <div class="print-only mb-4 text-center">
                        <h1 class="text-2xl font-bold mb-1">ÒÇÑÔ ÌÇãÚ ãÇåíÇäå ÇÑÌÇÚÇÊ ˜ÇÑ</h1>
                        <p class="text-sm text-gray-700">ÊÇÑíÎ Êåíå ÒÇÑÔ: ${new Date().toLocaleDateString('fa-IR')}</p>
                        <hr class="my-3 border-gray-300"/>
                    </div>
                    <div class="space-y-8">
                `;
                
                let grandTotalCost = 0;
                let grandTotalProjects = 0;

                for (const monthKey of sortedMonthKeys) {
                    const monthData = projectsByMonth[monthKey];
                    grandTotalCost += monthData.totalCost;
                    grandTotalProjects += monthData.projectCount;
                    
                    // Group projects within the month by engineer for the breakdown table
                    const projectsByEngineerInMonth = monthData.projects.reduce((acc, proj) => {
                        if (!acc[proj.assignedEngineerId]) {
                            acc[proj.assignedEngineerId] = {
                                engineerName: proj.assignedEngineerName,
                                totalCost: 0,
                                projects: []
                            };
                        }
                        acc[proj.assignedEngineerId].totalCost += proj.cost;
                        acc[proj.assignedEngineerId].projects.push(proj);
                        return acc;
                    }, {});

                    reportHtml += `
                        <div class="border border-gray-300 rounded-lg overflow-hidden shadow-md">
                            <!-- Monthly Header -->
                            <div class="bg-indigo-700 text-white p-3 flex flex-wrap justify-between items-center text-xl font-bold">
                                <span>ÂãÇÑ ãÇå: ${monthKey}</span>
                                <div class="text-sm font-normal space-x-4 space-x-reverse">
                                    <span>ÊÚÏÇÏ ˜á ˜ÇÑåÇ: ${monthData.projectCount.toLocaleString('fa')}</span>
                                    <span> / </span>
                                    <span class="font-semibold">ÌãÚ åÒíäå ÇÑÌÇÚí: ${monthData.totalCost.toLocaleString('fa')} ã.Ê</span>
                                </div>
                            </div>
                            
                            <div class="p-3">
                                <h4 class="text-lg font-semibold mb-2 text-gray-700 border-b pb-2">ÌÒÆíÇÊ ÑæŽååÇ ÈÑ ÇÓÇÓ ãåäÏÓ:</h4>
                                
                                <div class="space-y-4">
                                ${Object.values(projectsByEngineerInMonth).map(engData => {
                                    const engineer = engineersMap[engData.projects[0].assignedEngineerId] || { rank: 'äÇãÔÎÕ' };
                                    return `
                                        <div class="border-b border-dashed pb-3 last:border-b-0">
                                            <p class="font-bold text-blue-800 text-md mb-1">${engData.engineerName} (${engineer.rank}) - ãÌãæÚ: ${engData.totalCost.toLocaleString('fa')} ã.Ê</p>
                                            <table class="report-table w-full text-xs">
                                                <thead>
                                                    <tr class="bg-gray-100 text-gray-700">
                                                        <th class="py-1 w-[5%]">ÑÏíÝ</th>
                                                        <th class="w-[15%]">ÊÇÑíÎ ÇÑÌÇÚ</th>
                                                        <th class="w-[20%]">äÇã ãÊÞÇÖí</th>
                                                        <th class="w-[15%]">äæÚ ˜ÇÑ</th>
                                                        <th class="w-[10%]">åÒíäå (ã.Ê)</th>
                                                        <th class="w-[10%]">ãÊÑÇŽ (ã²)</th>
                                                        <th class="w-[25%]">ÇÑÇä</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${engData.projects.sort((a, b) => a.timestamp - b.timestamp).map((proj, index) => {
                                                        const date = new Date(proj.timestamp).toLocaleDateString('fa-IR');
                                                        const area = proj.area ? proj.area.toLocaleString('fa') : '-';
                                                        const organization = proj.organization || '-'; 
                                                        return `
                                                            <tr>
                                                                <td class="text-center">${index + 1}</td>
                                                                <td>${date}</td>
                                                                <td>${proj.clientName}</td>
                                                                <td>${proj.jobType}</td>
                                                                <td class="font-bold text-blue-700">${proj.cost.toLocaleString('fa')}</td>
                                                                <td>${area}</td>
                                                                <td>${organization}</td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    `;
                                }).join('')}
                                </div>
                            </div>
                        </div> <!-- End of Monthly Card -->
                    `;
                } // End of month loop

                // Grand Total Footer
                reportHtml += `
                    <div class="mt-8 p-4 bg-gray-800 text-white rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-2">ÎáÇÕå ˜á ÏæÑå</h3>
                        <div class="flex justify-between font-semibold">
                            <span>ÌãÚ ˜á ÑæŽååÇí ÇÑÌÇÚí: <span class="text-yellow-300">${grandTotalProjects.toLocaleString('fa')}</span> ãæÑÏ</span>
                            <span>ÌãÚ ˜á åÒíäååÇí ÇÑÌÇÚí: <span class="text-yellow-300">${grandTotalCost.toLocaleString('fa')}</span> ãíáíæä ÊæãÇä</span>
                        </div>
                    </div>
                `;
                
                reportHtml += '</div>';
                
                reportArea.innerHTML = reportHtml;
                window.printReport = () => window.print(); // Assign print function
                
            } catch (error) {
                console.error("Error generating monthly report:", error);
                reportArea.innerHTML = '<p class="text-center text-red-600 p-12">ÎØÇ ÏÑ ÊæáíÏ ÒÇÑÔ ãÇåíÇäå. áØÝÇð ÇÊÕÇá Èå ÇíäÊÑäÊ ÑÇ ÈÑÑÓí ˜ÑÏå æ ÏæÈÇÑå ÊáÇÔ ˜äíÏ.</p>';
                showMessage("ÎØÇ ÏÑ ÊæáíÏ ÒÇÑÔ ãÇåíÇäå.", 'error');
            }
        }
        window.showMonthlyReport = showMonthlyReport;


        // --- Firebase/Authentication Initialization ---
        
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("ÎØÇ: ÊäÙíãÇÊ ÝÇíÑÈíÓ ÏÑ ÏÓÊÑÓ äíÓÊ.", 'error');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        ENGINEER_COLLECTION = collection(db, `artifacts/${appId}/users/${userId}/engineers`);
                        PROJECTS_COLLECTION = collection(db, `artifacts/${appId}/users/${userId}/projects`);
                        
                        setupListeners();
                        populateJobTypes();

                    } else {
                        userId = null;
                        isAuthReady = true; 
                        showMessage("ÎØÇ ÏÑ ÇÍÑÇÒ åæíÊ. Çã˜Çä ÐÎíÑå ÇØáÇÚÇÊ æÌæÏ äÏÇÑÏ.", 'error');
                    }
                    
                    showView('dashboardView');
                });
                
                detailsModalRef = document.getElementById('detailsModal');
                modalTitleRef = document.getElementById('modalTitle');
                projectsListRef = document.getElementById('projectsList');
                modalLoadingMessageRef = document.getElementById('modalLoadingMessage');
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`ÎØÇí ÇÊÕÇá: ${error.message}`, 'error');
            }
        }

        // --- Firestore Listeners ---

        function setupListeners() {
            if (!isAuthReady || !userId) return;

            // Listener for Engineers (for dashboard and for caching map)
            const q = query(ENGINEER_COLLECTION);
            onSnapshot(q, (snapshot) => {
                const engineers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update Cache Map
                allEngineersMap = engineers.reduce((map, eng) => {
                    map[eng.id] = eng;
                    return map;
                }, {});

                renderEngineers(engineers);
            }, (error) => {
                console.error("Snapshot error (Engineers):", error);
                showMessage("ÎØÇ ÏÑ ÏÑíÇÝÊ áíÓÊ ãåäÏÓÇä.", 'error');
            });
            
            // Note: Project listener is not needed here as we use getDocs for reports/details.
        }
        
        // --- UI Initialization and Events ---

        function populateJobTypes() {
            const select = document.getElementById('jobType');
            select.innerHTML = '<option value="" disabled selected>ÇäÊÎÇÈ äæÚ ˜ÇÑ...</option>'; 

            for (const job of Object.keys(PROJECT_COSTS)) {
                const option = document.createElement('option');
                option.value = job;
                option.textContent = job; 
                select.appendChild(option);
            }
        }
        
        // ?. ËÈÊ ãåäÏÓ ÌÏíÏ
        document.getElementById('addEngineerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showMessage("áØÝÇð ãäÊÙÑ ÈãÇäíÏ ÊÇ ÇÊÕÇá ÈÑÞÑÇÑ ÔæÏ.", 'info');
                return;
            }

            const name = document.getElementById('engineerName').value.trim();
            const rank = document.getElementById('engineerRank').value;

            if (!name || !rank) {
                showMessage("áØÝÇð äÇã æ Çíå ãåäÏÓ ÑÇ æÇÑÏ ˜äíÏ.", 'info');
                return;
            }

            const maxQuota = RANK_QUOTAS[rank];

            if (maxQuota === undefined) {
                 showMessage("Çíå ãåäÏÓí äÇãÚÊÈÑ ÇÓÊ.", 'error');
                 return;
            }

            const engineerData = {
                fullName: name,
                rank: rank,
                maxQuota: maxQuota,
                usedQuota: 0,
            };

            try {
                await addDoc(ENGINEER_COLLECTION, engineerData);
                showMessage(`ãåäÏÓ ${name} ÈÇ Çíå ${rank} ÈÇ ãæÝÞíÊ ËÈÊ ÔÏ.`, 'success');
                document.getElementById('addEngineerForm').reset();
                showView('dashboardView');
            } catch (error) {
                console.error("Error adding engineer:", error);
                showMessage(`ÎØÇ ÏÑ ËÈÊ ãåäÏÓ: ${error.message}`, 'error');
            }
        });

        // ?. ÇÑÌÇÚ ˜ÇÑ ÌÏíÏ (ÈÇ ãäØÞ ÇÕáÇÍ ÔÏå ÇæáæíÊÈäÏí Óåãíå ÎÇáí)
        document.getElementById('assignProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showMessage("áØÝÇð ãäÊÙÑ ÈãÇäíÏ ÊÇ ÇÊÕÇá ÈÑÞÑÇÑ ÔæÏ.", 'info');
                return;
            }

            const clientName = document.getElementById('clientName').value.trim();
            const jobType = document.getElementById('jobType').value;
            const manualCostInput = document.getElementById('manualCost');
            
            const resultBox = document.getElementById('assignmentResult');
            const resultText = document.getElementById('resultText');
            resultBox.classList.add('hidden');

            if (!clientName || !jobType || !manualCostInput) {
                showMessage("áØÝÇð ÊãÇã ÝíáÏåÇí áÇÒã (ÇÒ Ìãáå åÒíäå ÏÓÊí æ äÇã ãÊÞÇÖí) ÑÇ Ñ ˜äíÏ.", 'info');
                return;
            }

            const jobCost = parseFloat(manualCostInput.value);
            if (isNaN(jobCost) || jobCost <= 0) {
                 showMessage("áØÝÇð í˜ åÒíäå ãÚÊÈÑ (ÈÒÑÊÑ ÇÒ ÕÝÑ) ÑÇ Èå ÕæÑÊ ÏÓÊí æÇÑÏ ˜äíÏ.", 'error');
                 return;
            }

            const projectAreaInput = document.getElementById('projectArea');
            const relatedOrganizationSelect = document.getElementById('relatedOrganization');
            const jobDetail = JOB_DETAILS[jobType];

            const projectArea = projectAreaInput ? parseFloat(projectAreaInput.value) : null;
            let relatedOrganization = null; 

            if (jobDetail) {
                if (jobDetail.organization === 'ÔåÑÏÇÑí') {
                    relatedOrganization = 'ÔåÑÏÇÑí';
                } else if (relatedOrganizationSelect) {
                    relatedOrganization = relatedOrganizationSelect.value;
                    if (!relatedOrganization) {
                         showMessage("áØÝÇð ÇÑÇä ãÑÈæØå ÑÇ ÇäÊÎÇÈ ˜äíÏ.", 'error');
                         return;
                    }
                }
            }

            if (projectAreaInput && (isNaN(projectArea) || projectArea <= 0)) {
                 showMessage("áØÝÇð ãÊÑÇŽ ãÚÊÈÑí (ÈÒÑÊÑ ÇÒ ÕÝÑ) ÑÇ æÇÑÏ ˜äíÏ.", 'error');
                 return;
            }

            
            let assignedEngineer = null;
            let debtIncurred = 0;

            try {
                const preFetchSnapshot = await getDocs(query(ENGINEER_COLLECTION));

                if (preFetchSnapshot.empty) {
                    throw new Error("engineer_not_found");
                }

                const engineers = preFetchSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    docRef: doc.ref, 
                    ...doc.data(),
                    // ÏÞÊ ˜äíÏ ˜å RemainingQuota ÏÑ Çíä ãÑÍáå ÝÞØ ÈÑÇí ãÍÇÓÈå æ ÝíáÊÑ ˜ÑÏä ÇÓÊÝÇÏå ãíÔæÏ.
                    remainingQuota: doc.data().maxQuota - doc.data().usedQuota 
                }));

                let candidateEngineer = null;
                
                // 1. PHASE 1: Find Engineer with Sufficient Free Quota
                let suitableEngineers = engineers.filter(eng => eng.remainingQuota >= jobCost);

                if (suitableEngineers.length > 0) {
                    // Sort by: Highest Rank, then Highest Remaining Quota
                    suitableEngineers.sort((a, b) => {
                        const rankA = RANK_PRIORITY[a.rank] || 0;
                        const rankB = RANK_PRIORITY[b.rank] || 0;
                        
                        if (rankB !== rankA) {
                            return rankB - rankA;
                        }
                        return b.remainingQuota - a.remainingQuota;
                    });
                    
                    candidateEngineer = suitableEngineers[0];
                    debtIncurred = 0;
                    
                } else {
                    // 2. PHASE 2: No Sufficient Free Quota - Apply One-Time Overdraft Policy
                    
                    // ÝíáÊÑ ˜ÑÏä: ÝÞØ ãåäÏÓÇäí ˜å åäæÒ æÇÑÏ ÈÏåí äÔÏåÇäÏ (usedQuota < maxQuota + small buffer) ãÌÇÒ Èå Óåãíå ãÇÒÇÏ åÓÊäÏ
                    const OVERDRAFT_TOLERANCE = 0.1; // ÈÑÇí ãÞÇÈáå ÈÇ ÎØÇåÇí ãÍÇÓÈÇÊ ÇÚÔÇÑí
                    let overdraftCandidates = engineers.filter(eng => {
                        // ÇÑ usedQuota ÇÒ maxQuota ÈíÔÊÑ äÈÇÔÏ (íÇ ÏÑ ÍÏ ÇÚÔÇÑ)¡ ãÌÇÒ ÇÓÊ
                        return eng.usedQuota <= (eng.maxQuota + OVERDRAFT_TOLERANCE); 
                    });
                    
                    if (overdraftCandidates.length > 0) {
                        // ãÑÊÈ ÓÇÒí ˜ÇäÏíÏÇåÇí ãÌÇÒ ÈÑÇí Óåãíå ãÇÒÇÏ:
                        // ÇæáæíÊ: Çíå ÈÇáÇÊÑ¡ ÓÓ ˜ãÊÑíä ÈÏåí (ÈÇáÇÊÑíä Óåãíå ÈÇÞíãÇäÏå¡ ˜å ãã˜ä ÇÓÊ ÕÝÑ íÇ ˜ãí ãËÈÊ ÈÇÔÏ)
                        overdraftCandidates.sort((a, b) => {
                            const rankA = RANK_PRIORITY[a.rank] || 0;
                            const rankB = RANK_PRIORITY[b.rank] || 0;
                            
                            if (rankB !== rankA) {
                                return rankB - rankA; // ÈÇáÇÊÑíä Çíå Çæá
                            }
                            // ÈÇáÇÊÑíä Óåãíå ÈÇÞíãÇäÏå (˜ãÊÑíä äíÇÒ Èå ÈÏåí)
                            return b.remainingQuota - a.remainingQuota; 
                        });
                        
                        candidateEngineer = overdraftCandidates[0];
                        
                        const currentRemaining = candidateEngineer.maxQuota - candidateEngineer.usedQuota;
                        debtIncurred = jobCost - currentRemaining; // ãÍÇÓÈå ãíÒÇä ÈÏåí ÌÏíÏ (ÈÒÑÊÑ ÇÒ 0 ÎæÇåÏ ÈæÏ)
                        
                    } else {
                        // 3. PHASE 3: Fallback - All engineers have already used their one-time overdraft (are in debt).
                        throw new Error("all_engineers_in_debt_must_reset");
                    }
                }

                if (!candidateEngineer) {
                    // Should be caught by one of the errors above, but as a safeguard:
                    throw new Error("no_eligible_engineer");
                }


                const engineerRef = doc(db, `artifacts/${appId}/users/${userId}/engineers`, candidateEngineer.id);
                
                // 4. ATOMIC UPDATE (Transaction)
                await runTransaction(db, async (transaction) => {
                    
                    const latestEngineerDoc = await transaction.get(engineerRef);
                    
                    if (!latestEngineerDoc.exists()) {
                        throw new Error("engineer_deleted");
                    }

                    // Increment usedQuota by the jobCost
                    transaction.update(engineerRef, {
                        usedQuota: increment(jobCost)
                    });

                    assignedEngineer = { ...latestEngineerDoc.data(), id: candidateEngineer.id };
                });


                // 5. Record the project history
                if (assignedEngineer) {
                    const projectData = {
                        clientName: clientName,
                        jobType: jobType,
                        cost: jobCost,
                        assignedEngineerId: assignedEngineer.id,
                        assignedEngineerName: assignedEngineer.fullName,
                        timestamp: Date.now(),
                        area: projectArea,
                        organization: relatedOrganization
                    };
                    
                    await addDoc(PROJECTS_COLLECTION, projectData);

                    resultBox.classList.remove('hidden', 'bg-red-100', 'border-red-500', 'bg-yellow-100', 'border-yellow-500');
                    resultBox.classList.add('bg-green-100', 'border-green-500');
                    
                    let debtMessage = '';
                    if (debtIncurred > 0) {
                        debtMessage = `<p class="text-sm font-bold text-red-700 mt-2">ÊæÌå: ${debtIncurred.toLocaleString('fa')} ã.Ê Óåãíå ãÇÒÇÏ (ÈÏåí) Èå Çíä ãåäÏÓ ÊÚáÞ ÑÝÊ.</p>`;
                        resultBox.classList.remove('bg-green-100', 'border-green-500');
                        resultBox.classList.add('bg-yellow-100', 'border-yellow-500');
                    }

                    resultText.innerHTML = `
                        <span class="text-green-700 font-bold">ÇÑÌÇÚ ÈÇ ãæÝÞíÊ ÇäÌÇã ÔÏ!</span><br>
                        <strong>äæÚ ˜ÇÑ:</strong> ${jobType} (${jobCost.toLocaleString('fa')} ã.Ê)<br>
                        <strong>ãåäÏÓ ãäÊÎÈ:</strong> <span class="text-lg text-blue-800 font-bold">${assignedEngineer.fullName}</span>
                        ${debtMessage}
                    `;
                    document.getElementById('assignProjectForm').reset();
                    document.getElementById('dynamicInputs').innerHTML = '<p class="text-sm text-gray-500 text-center">áØÝÇð äæÚ ˜ÇÑ ÑÇ ÇäÊÎÇÈ ˜äíÏ ÊÇ ÌÒÆíÇÊ ÑæŽå ãÔÎÕ ÔæÏ.</p>'; 
                    showMessage(`˜ÇÑ Èå ãåäÏÓ ${assignedEngineer.fullName} ÇÑÌÇÚ ÔÏ.`, 'success');
                }

            } catch (error) {
                let displayError = "ÎØÇí äÇãÔÎÕ ÏÑ ÇÑÌÇÚ ˜ÇÑ.";
                
                switch (error.message) {
                    case "engineer_not_found":
                    case "no_eligible_engineer":
                        displayError = "åí ãåäÏÓí ÏÑ ÓíÓÊã ËÈÊ äÔÏå ÇÓÊ. áØÝÇð ÇÈÊÏÇ ãåäÏÓ ËÈÊ ˜äíÏ.";
                        break;
                    case "engineer_deleted":
                        displayError = "ÎØÇ ÏÑ ÇÑÌÇÚ ˜ÇÑ: ãÔÎÕÇÊ ãåäÏÓ ÏÑ Ííä ÚãáíÇÊ ÍÐÝ ÔÏå ÇÓÊ.";
                        break;
                    case "all_engineers_in_debt_must_reset":
                        displayError = "Óåãíå ÊãÇã ãåäÏÓÇä Ñ ÔÏå æ Óåãíå ãÇÒÇÏ í˜ÈÇÑå ÂäåÇ äíÒ ÇÓÊÝÇÏå ÔÏå ÇÓÊ. áØÝÇ ÈÇ ÇÓÊÝÇÏå ÇÒ Ï˜ãå 'ÈÇÒ ˜ÑÏä Óåãíå ÌÏíÏ' ÏÑ ÏÇÔÈæÑÏ¡ Óåãíå ÑÇ ÊãÏíÏ ˜äíÏ.";
                        break;
                    default:
                        console.error("Assignment error:", error);
                        displayError = `ÎØÇ ÏÑ ÇÑÌÇÚ ˜ÇÑ: ${error.message}`;
                }

                resultBox.classList.remove('hidden', 'bg-green-100', 'border-green-500', 'bg-yellow-100', 'border-yellow-500');
                resultBox.classList.add('bg-red-100', 'border-red-500');
                
                resultText.textContent = displayError;
                showMessage(displayError, 'error');
            }
        });

        // Start the application
        window.onload = initializeFirebase;
    </script>
</body>

</html>
