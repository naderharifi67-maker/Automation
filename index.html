<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, runTransaction, query, where, getDocs, increment, writeBatch, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

    // ğŸ”‘ UID Ø§Ø¯Ù…ÛŒÙ† ØµØ­ÛŒØ­ Ùˆ Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§
    const ADMIN_UID = "v1Ljqk88gJVykzh80uiytdyuTpi2"; 

    // CONFIG OBJECT (ØªÙ†Ø¸ÙŠÙ…Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø´Ù…Ø§)
    const firebaseConfig = { 
        apiKey: "AIzaSyChV9mCptF4qybDn_yaOhmSz-KI3LhtDEQ",
        authDomain: "database-erjakar.firebaseapp.com",
        projectId: "database-erjakar",
        storageBucket: "database-erjakar.firebasestorage.app",
        messagingSenderId: "1056379437698",
        appId: "1:1056379437698:web:2a6bffc8ea0f1949436a9b",
        measurementId: "G-NS5ZPEFXD8"
    };
    
    // ØªÙ†Ø¸ÙŠÙ…Ø§Øª Ø³Ø±Ø§Ø³Ø±ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
    let app, db, auth;
    let currentAuthUser = null; // Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ú©Ù„ Ø¢Ø¨Ø¬Ú©Øª Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÙŠ (Anonymous ÙŠØ§ Admin)
    let isAuthReady = false;
    
    // --- Static Data ---
    const PROJECT_COSTS = {
        'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': 1,
        'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': 2,
        'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': 4, 
    };
    
    const JOB_DETAILS = {
        'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
        'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ú©Ù„ Ø²ÙŠØ± Ø¨Ù†Ø§ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
        'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' }, 
    };

    const RANK_QUOTAS = {
        'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 10,
        'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 15,
        'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 20,
    };
    
    const RANK_PRIORITY = {
        'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 3,
        'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 2,
        'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 1,
    };

    const UTM_ORGANIZATIONS = [
        'Ø§ÙˆÙ‚Ø§Ù Ùˆ Ø§Ù…ÙˆØ±Ø®ÙŠØ±ÙŠÙ‡',
        'Ø¨Ù†ÙŠØ§Ø¯ Ù…Ø³Ú©Ù†',
        'Ø¬Ù‡Ø§Ø¯ Ú©Ø´Ø§ÙˆØ±Ø²ÙŠ',
        'Ù…Ù†Ø§Ø¨Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ',
        'Ø§Ø¯Ø§Ø±Ù‡ Ø«Ø¨Øª Ø§Ø³Ù†Ø§Ø¯ Ùˆ Ø§Ù…Ù„Ø§Ú©',
        'Ù…ÙŠØ±Ø§Ø« ÙØ±Ù‡Ù†Ú¯ÙŠ',
        'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' 
    ];

    let ENGINEER_COLLECTION, PROJECTS_COLLECTION;
    let allEngineersMap = {};
    let allProjects = [];

    let detailsModalRef, modalTitleRef, projectsListRef, modalLoadingMessageRef;
    
    
    // ====================================================================
    // === NEW ACCESS CONTROL FUNCTIONS (ØªÙˆØ§Ø¨Ø¹ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÙŠ Ø¬Ø¯ÙŠØ¯) ===
    // ====================================================================

    /**
     * Ø¨Ø±Ø±Ø³ÙŠ Ù…ÙŠâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¢ÙŠØ§ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù‡Ù…Ø§Ù† Ø§Ø¯Ù…ÙŠÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø§Ø³Øª ÙŠØ§ Ø®ÙŠØ±.
     * @returns {boolean}
     */
    function isCurrentUserAdmin() {
        return currentAuthUser && currentAuthUser.uid === ADMIN_UID;
    }

    /**
     * Ù…Ø¯ÙŠØ±ÙŠØª Ù†Ù…Ø§ÙŠØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ø¹Ù†Ø§ØµØ± Ù…Ø¯ÙŠØ±ÙŠØªÙŠ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÙŠ.
     */
    function handleAccessControl() {
        const adminButtons = [
            document.querySelector('button[onclick="showView(\'addEngineerModal\')"]'), // Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯
            document.querySelector('button[onclick="showView(\'assignProjectModal\')"]'), // Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÙŠØ¯
            document.getElementById('newQuotaButtonContainer') // Ø¯Ú©Ù…Ù‡ ØªØ³ÙˆÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ
        ];
        
        const isAdmin = isCurrentUserAdmin();

        adminButtons.forEach(btn => {
            if (btn) {
                if (isAdmin) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            }
        });

        // Ù‡Ù…Ú†Ù†ÙŠÙ† Ø¯Ú©Ù…Ù‡ ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ ØªÚ© Ù…Ù‡Ù†Ø¯Ø³ Ø¯Ø± ØªØ§Ø¨Ø¹ renderEngineers Ú©Ù†ØªØ±Ù„ Ù…ÙŠâ€ŒØ´ÙˆØ¯.
    }

    
    // ====================================================================
    // === AUTHENTICATION HANDLERS (Ù…Ø¯ÙŠØ±ÙŠØª ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬) ===
    // ====================================================================
    
    // ØªØ¹Ø±ÙŠÙ Ù…ØªØ¯ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„
    const provider = new GoogleAuthProvider();

    /**
     * Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÙŠÙ†Ø¯ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„
     */
    window.signInWithGoogle = async () => {
        try {
            await signInWithPopup(auth, provider);
            // Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ØŒ onAuthStateChanged ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            // showMessage('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯.', 'success');
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„:", error);
            showMessage('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„. Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ø§Ø³Øª.', 'error');
        }
    };
    
    /**
     * Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø±
     */
    window.signOutUser = async () => {
        try {
            await signOut(auth);
            showMessage('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.', 'info');
            // Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬ØŒ onAuthStateChanged ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬:", error);
            showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬.', 'error');
        }
    };


    // ====================================================================
    // === UTILITY FUNCTIONS (ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø¯ÙŠ) ===
    // ====================================================================

    function formatCost(cost) {
        if (typeof cost !== 'number' || isNaN(cost)) return '0';
        return new Intl.NumberFormat('fa-IR').format(cost.toFixed(2)) + ' Ù….Øª';
    }

    function showMessage(message, type) {
        const box = document.getElementById('messageBox');
        box.textContent = message;
        box.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center';

        switch (type) {
            case 'success':
                box.classList.add('bg-green-500', 'text-white');
                break;
            case 'error':
                box.classList.add('bg-red-500', 'text-white');
                break;
            case 'info':
                box.classList.add('bg-blue-500', 'text-white');
                break;
        }

        box.classList.remove('hidden');

        setTimeout(() => {
            box.classList.add('hidden');
        }, 5000);
    }

    function showView(viewId) {
        document.querySelectorAll('.view-container > div').forEach(view => {
            view.classList.add('hidden-view');
        });
        
        const view = document.getElementById(viewId);
        if (view) {
             view.classList.remove('hidden-view');
        } else {
             // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù†Ù…Ø§ÙŠ Ø§Ø¯Ù…ÙŠÙ† Ø¯Ø³ØªØ±Ø³ÙŠ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
             document.getElementById('dashboardView').classList.remove('hidden-view');
             if (!isCurrentUserAdmin() && (viewId === 'addEngineerModal' || viewId === 'assignProjectModal')) {
                 showMessage('Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÙŠ Ø§Ø¯Ù…ÙŠÙ† Ø¨Ø±Ø§ÙŠ Ø§Ù†Ø¬Ø§Ù… Ø§ÙŠÙ† Ø¹Ù…Ù„ÙŠØ§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÙŠØ¯.', 'error');
             }
        }
        
        if (viewId === 'assignProjectModal') {
            renderDynamicInputs(document.getElementById('jobType').value);
        }

        closeModal('detailsModal');
        closeModal('printReportModal');
        closeModal('confirmationModal');
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }
    
    function openModal(modalId) {
          const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
        }
    }
    
    // ... (ØªÙˆØ§Ø¨Ø¹ calculateDynamicCost Ùˆ renderDynamicInputs Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø¨Ø§Ù‚ÙŠ Ù…ÙŠâ€ŒÙ…Ø§Ù†Ù†Ø¯)
    function calculateDynamicCost(jobType, area) {
        const baseCost = PROJECT_COSTS[jobType] || 0;
        let finalCost = baseCost;

        if (jobType === 'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ' && area > 0) {
             finalCost = baseCost + (area * 0.005);
        } else if (jobType === 'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ' && area > 0) {
             finalCost = baseCost + (area * 0.007);
        } else if (jobType === 'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…' && area > 0) {
             finalCost = baseCost + (area * 0.01);
        }
        
        return Math.ceil(finalCost * 10) / 10;
    }


    function renderDynamicInputs(jobType) {
        const container = document.getElementById('dynamicInputs');
        container.innerHTML = ''; 

        if (!jobType) {
             container.innerHTML = '<p class="text-sm text-gray-500 text-center">Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯ ØªØ§ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.</p>';
             return;
        }

        const details = JOB_DETAILS[jobType];
        
        if (details.isAreaRequired) {
             const areaInput = `
                 <div>
                     <label for="projectArea" class="block text-sm font-medium text-gray-700 mb-1">${details.label}</label>
                     <input type="number" step="1" min="1" id="projectArea" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: 120">
                 </div>
                `;
             container.innerHTML += areaInput;
        }

        let selectedOrganization = details.organization;

        if (details.organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
             const orgSelect = document.createElement('select');
             orgSelect.id = 'relatedOrganization';
             orgSelect.required = true;
             orgSelect.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500';
             
             const defaultOption = document.createElement('option');
             defaultOption.value = '';
             defaultOption.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡...';
             defaultOption.disabled = true;
             defaultOption.selected = true;
             orgSelect.appendChild(defaultOption);

             UTM_ORGANIZATIONS.forEach(org => {
                 const option = document.createElement('option');
                 option.value = org;
                 option.textContent = org;
                 orgSelect.appendChild(option);
             });
             
             const orgDiv = document.createElement('div');
             orgDiv.innerHTML = '<label for="relatedOrganization" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø±Ú¯Ø§Ù† Ù…ØªÙ‚Ø§Ø¶ÙŠ Ù†Ù‚Ø´Ù‡ UTM:</label>';
             orgDiv.appendChild(orgSelect);
             container.appendChild(orgDiv);
             selectedOrganization = orgSelect.value;
        }
        
        const initialCost = PROJECT_COSTS[jobType] || 0;
        const costInput = `
             <div>
                 <label for="manualCost" class="block text-sm font-medium text-gray-700 mb-1">Ù‡Ø²ÙŠÙ†Ù‡ Ù†Ù‡Ø§ÙŠÙŠ (Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù† - Ù‚Ø§Ø¨Ù„ ÙˆÙŠØ±Ø§ÙŠØ´):</label>
                 <input type="number" step="0.1" min="0.1" id="manualCost" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${initialCost.toFixed(1)}">
             </div>
             <div id="calculatedCostInfo" class="text-xs text-gray-500 p-2 border-t mt-2">
                 <span class="font-bold">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡:</span> ${selectedOrganization}
             </div>
        `;
        container.innerHTML += costInput;

        const projectAreaEl = document.getElementById('projectArea');
        const manualCostEl = document.getElementById('manualCost');

        const updateCost = () => {
            const area = projectAreaEl ? parseFloat(projectAreaEl.value) : 0;
            let calculated = calculateDynamicCost(jobType, area);
            
            if (manualCostEl) {
                 manualCostEl.value = calculated.toFixed(1);
            }
        }

        if (projectAreaEl) {
            projectAreaEl.addEventListener('input', updateCost);
            if (projectAreaEl.value) updateCost();
        }
        
        if (document.getElementById('relatedOrganization')) {
            document.getElementById('relatedOrganization').addEventListener('change', (e) => {
                 document.getElementById('calculatedCostInfo').innerHTML = `<span class="font-bold">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡:</span> ${e.target.value}`;
            });
        }
    }
    
    document.getElementById('jobType').addEventListener('change', (e) => {
        renderDynamicInputs(e.target.value);
    });
    
    // ====================================================================
    // === CORE FIREBASE INITIALIZATION & AUTHENTICATION (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ===
    // ====================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
        const jobTypeSelect = document.getElementById('jobType');
        Object.keys(PROJECT_COSTS).forEach(jobType => {
            const option = document.createElement('option');
            option.value = jobType;
            option.textContent = jobType;
            jobTypeSelect.appendChild(option);
        });
        
        detailsModalRef = document.getElementById('detailsModal');
        modalTitleRef = document.getElementById('modalTitle');
        projectsListRef = document.getElementById('projectsList');
        modalLoadingMessageRef = document.getElementById('modalLoadingMessage');
        
        initializeFirebase();
        
        // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬
        document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);
        document.getElementById('signOutBtn').addEventListener('click', signOutUser);

    });


    function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, (user) => {
                currentAuthUser = user;
                isAuthReady = true;
                
                handleAccessControl(); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†

                if (user) {
                    const isAdmin = isCurrentUserAdmin();
                    
                    // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬
                    document.getElementById('googleSignInBtn').classList.add('hidden');
                    document.getElementById('signOutBtn').classList.remove('hidden');


                    if (isAdmin) {
                        showMessage(`Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÙŠÙ† (${user.uid.substring(0, 8)}...) Ù…ØªØµÙ„ Ø´Ø¯ÙŠØ¯. ØªÙ…Ø§Ù… Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÙŠ Ù…Ø¯ÙŠØ±ÙŠØªÙŠ ÙØ¹Ø§Ù„ Ø´Ø¯Ù†Ø¯.`, 'success');
                    } else if (!user.isAnonymous) {
                         showMessage(`Ø´Ù…Ø§ Ø¨Ø§ Ø­Ø³Ø§Ø¨ Ú¯ÙˆÚ¯Ù„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§ÙŠØ¯ Ùˆ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²Ø¯ÙŠØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø³ØªØ±Ø³ÙŠ Ø¯Ø§Ø±ÙŠØ¯.`, 'info');
                    } else {
                         // Ø­Ø§Ù„Øª Ù†Ø§Ø´Ù†Ø§Ø³
                         showMessage(`Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²Ø¯ÙŠØ¯Ú©Ù†Ù†Ø¯Ù‡ Ù†Ø§Ø´Ù†Ø§Ø³ Ù…ØªØµÙ„ Ø´Ø¯ÛŒØ¯.`, 'info');
                    }
                    
                    ENGINEER_COLLECTION = collection(db, 'engineers');
                    PROJECTS_COLLECTION = collection(db, 'projects');

                    startRealtimeListeners();
                    showView('dashboardView');
                    
                } else {
                    // Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ (Ø­ØªÛŒ Ù†Ø§Ø´Ù†Ø§Ø³)
                    currentAuthUser = null;
                    document.getElementById('googleSignInBtn').classList.remove('hidden');
                    document.getElementById('signOutBtn').classList.add('hidden');
                    
                    // **Ø§ØµÙ„Ø§Ø­ Ù†Ù‡Ø§ÛŒÛŒ:** ØªÙ†Ù‡Ø§ Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¨Ø§ Ù†Ø§Ø´Ù†Ø§Ø³ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒÙ… ØªØ§ Ø¨ØªÙˆØ§Ù†Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ø¯ (Ø·Ø¨Ù‚ Ù‚ÙˆØ§Ù†ÛŒÙ†)
                    if (!auth.currentUser) {
                         signInAnonymously(auth).catch((error) => {
                             console.error("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ù†Ø§Ø´Ù†Ø§Ø³:", error);
                             showMessage(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.code} - Anonymous Ø¨Ø§ÛŒØ¯ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯.`, 'error');
                         });
                    }
                    
                    showView('dashboardView');
                }
            });

        } catch (e) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³:", e);
            showMessage('Ø®Ø·Ø§: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
        }
    }
    
    // ====================================================================
    // === REALTIME LISTENERS & RENDERING (Ø­Ø§Ù„Øª Public) ===
    // ====================================================================

    function startRealtimeListeners() {
        if (!isAuthReady) return;

        const engineersQuery = query(ENGINEER_COLLECTION); // ALL Engineers
        const projectsQuery = query(PROJECTS_COLLECTION); // ALL Projects


        onSnapshot(engineersQuery, (querySnapshot) => {
            const engineers = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                allEngineersMap[doc.id] = { id: doc.id, ...data };
                engineers.push({ id: doc.id, ...data });
            });
            renderEngineers(engineers);
        }, (error) => {
            console.error("Error listening to engineers collection: ", error);
            showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†: " + error.message, 'error');
        });
        
        onSnapshot(projectsQuery, (querySnapshot) => {
            allProjects = [];
            querySnapshot.forEach((doc) => {
                allProjects.push({ id: doc.id, ...doc.data() });
            });
        }, (error) => {
            console.error("Error listening to projects collection: ", error);
            showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§: " + error.message, 'error');
        });
    }


    /**
     * Ø±Ù†Ø¯Ø± Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
     * @param {Array<Object>} engineers 
     */
    function renderEngineers(engineers) {
        const listContainer = document.getElementById('engineerList');
        const loadingMessage = document.getElementById('loadingMessage');
        const quotaBtnContainer = document.getElementById('newQuotaButtonContainer');

        loadingMessage.classList.add('hidden');
        
        if (engineers.length === 0) {
             listContainer.innerHTML = '<p class="text-center text-xl text-gray-500 p-8"> Ù‡ÛŒÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
             quotaBtnContainer.classList.add('hidden');
             return;
        }

        engineers.sort((a, b) => {
            const rankA = RANK_PRIORITY[a.rank] || 0;
            const rankB = RANK_PRIORITY[b.rank] || 0;
            if (rankA !== rankB) {
                return rankB - rankA;
            }
            return b.debt - a.debt;
        });
        
        let html = '';
        let allDebtsSettled = true;
        const isAdmin = isCurrentUserAdmin();

        engineers.forEach(eng => {
            const quotaMax = RANK_QUOTAS[eng.rank] || 0;
            const remainingQuota = Math.max(0, quotaMax - eng.debt);
            const debtPercent = quotaMax > 0 ? (eng.debt / quotaMax) * 100 : 0;
            const isOverQuota = eng.debt > quotaMax;
            
            if (eng.debt > 0) {
                allDebtsSettled = false;
            }

            // Ø¯Ú©Ù…Ù‡ ØªØ³ÙˆÙŠÙ‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÙŠ Ø§Ø¯Ù…ÙŠÙ† Ù†Ù…Ø§ÙŠØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÙŠâ€ŒØ´ÙˆØ¯
            const resetBtnHtml = isAdmin ? `
                 <button onclick="showConfirmation('resetQuota', '${eng.id}', '${eng.name}')" 
                     class="bg-red-500 text-white p-2 text-sm rounded-lg hover:bg-red-600 transition shadow-md">
                     ØªØ³ÙˆÙŠÙ‡
                 </button>
            ` : '';

            html += `
                 <div class="p-4 bg-white rounded-lg card flex items-center justify-between transition duration-150 hover:shadow-lg border ${isOverQuota ? 'border-red-500' : 'border-blue-200'}">
                     <div class="flex-1 min-w-0">
                         <h4 class="text-lg font-bold text-gray-800 truncate">${eng.name}</h4>
                         <p class="text-sm text-blue-600 font-semibold">${eng.rank}</p>
                         <p class="text-xs text-gray-500 mt-1">Ø¢Ø®Ø±ÙŠÙ† Ø§Ø±Ø¬Ø§Ø¹: ${eng.lastAssignedProject || 'Ù†Ø¯Ø§Ø±Ø¯'}</p>
                     </div>

                     <div class="w-2/5 mx-4">
                         <div class="text-xs font-semibold flex justify-between mb-1">
                             <span class="${isOverQuota ? 'text-red-600' : 'text-gray-800'}">Ø¨Ø¯Ù‡ÙŠ: ${formatCost(eng.debt)}</span>
                             <span class="text-gray-600">Ø³Ù‡Ù…ÙŠÙ‡: ${formatCost(quotaMax)}</span>
                         </div>
                         <div class="w-full bg-gray-200 rounded-full h-2.5">
                             <div class="progress-bar-fill h-2.5 rounded-full ${isOverQuota ? 'bg-red-500' : 'bg-blue-500'}" style="width: ${Math.min(100, debtPercent)}%"></div>
                         </div>
                     </div>

                     <div class="text-right">
                         <p class="text-sm font-semibold ${isOverQuota ? 'text-red-700' : 'text-green-700'}">Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡:</p>
                         <p class="text-base font-bold ${isOverQuota ? 'text-red-700' : 'text-green-700'}">${formatCost(remainingQuota)}</p>
                     </div>
                     
                     <div class="ml-4 flex gap-2">
                         <button onclick="showEngineerProjects('${eng.id}', '${eng.name}')" 
                             class="bg-blue-500 text-white p-2 text-sm rounded-lg hover:bg-blue-600 transition shadow-md whitespace-nowrap">
                             Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§
                         </button>
                         ${resetBtnHtml}
                     </div>
                 </div>
            `;
        });

        listContainer.innerHTML = html;
        
        // Ø¯Ú©Ù…Ù‡ ØªØ³ÙˆÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ ÙÙ‚Ø· Ø§Ú¯Ø± Ø¨Ø¯Ù‡ÙŠ ØªØ³ÙˆÙŠÙ‡ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÙŠÙ† Ø¨Ø§Ø´Ø¯ØŒ Ù†Ù…Ø§ÙŠØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÙŠâ€ŒØ´ÙˆØ¯
        if (!allDebtsSettled && isAdmin) {
            quotaBtnContainer.classList.remove('hidden');
        } else {
            quotaBtnContainer.classList.add('hidden');
        }
    }
    
    // ====================================================================
    // === CORE LOGIC (ADD/ASSIGN/RESET) (Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÙŠ Ø³Ù…Øª Ú©Ù„Ø§ÙŠÙ†Øª) ===
    // ====================================================================

    // Engineer Submission
    document.getElementById('addEngineerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÙŠ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª
        if (!isAuthReady || !isCurrentUserAdmin()) {
            showMessage('Ø¯Ø³ØªØ±Ø³ÙŠ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÙŠ Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø±Ø§ Ù†Ø¯Ø§Ø±ÙŠØ¯.', 'error');
            return;
        }

        const name = document.getElementById('engineerName').value.trim();
        const rank = document.getElementById('engineerRank').value;

        if (name === "" || rank === "") {
            showMessage('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÙŠØ¯.', 'error');
            return;
        }
        
        const newEngineer = {
            name: name,
            rank: rank,
            quotaMax: RANK_QUOTAS[rank] || 0,
            debt: 0,
            lastAssignedProject: null,
            userId: ADMIN_UID, // ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ù†ÙˆØ² Ø¨Ø§ Ø¢ÙŠØ¯ÙŠ Ø§Ø¯Ù…ÙŠÙ† Ø´Ù…Ø§ Ø°Ø®ÙŠØ±Ù‡ Ù…ÙŠâ€ŒØ´ÙˆÙ†Ø¯
            createdAt: serverTimestamp(),
        };

        try {
            await addDoc(ENGINEER_COLLECTION, newEngineer);
            showMessage(`Ù…Ù‡Ù†Ø¯Ø³ ${name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø«Ø¨Øª Ø´Ø¯.`, 'success');
            document.getElementById('addEngineerForm').reset();
            showView('dashboardView');
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³: ", error);
            showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯.', 'error');
        }
    });


    // Project Assignment
    document.getElementById('assignProjectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÙŠ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª
        if (!isAuthReady || !isCurrentUserAdmin()) {
            showMessage('Ø¯Ø³ØªØ±Ø³ÙŠ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÙŠ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø±Ø§ Ù†Ø¯Ø§Ø±ÙŠØ¯.', 'error');
            return;
        }
        
        // ... (Ø¨Ù‚ÙŠÙ‡ Ù…Ù†Ø·Ù‚ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
        const jobType = document.getElementById('jobType').value;
        const clientName = document.getElementById('clientName').value.trim();
        const projectAreaEl = document.getElementById('projectArea');
        const projectArea = projectAreaEl ? parseFloat(projectAreaEl.value) : 0;
        const manualCost = parseFloat(document.getElementById('manualCost').value);
        const relatedOrganizationEl = document.getElementById('relatedOrganization');
        let organization = JOB_DETAILS[jobType].organization;

        if (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' && relatedOrganizationEl) {
            organization = relatedOrganizationEl.value;
        } else if (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
            showMessage('Ù„Ø·ÙØ§Ù‹ Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯.', 'error');
            return;
        }

        if (jobType === "" || clientName === "" || isNaN(manualCost) || manualCost <= 0) {
              showMessage('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ Ø§Ù„Ø²Ø§Ù…ÙŠ Ø±Ø§ Ù¾Ø± Ú©Ù†ÙŠØ¯.', 'error');
              return;
        }
        
        try {
            const eligibleEngineers = Object.values(allEngineersMap)
                .filter(eng => {
                    const quotaMax = RANK_QUOTAS[eng.rank] || 0;
                    const remainingQuota = quotaMax - eng.debt;
                    return remainingQuota >= manualCost;
                })
                .sort((a, b) => a.debt - b.debt);

            if (eligibleEngineers.length === 0) {
                const resultDiv = document.getElementById('assignmentResult');
                resultDiv.classList.remove('hidden', 'border-r-4', 'border-green-500');
                resultDiv.classList.add('border-r-4', 'border-red-500');
                document.getElementById('resultText').textContent = `Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø§ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÙŠ (Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡ Ø¨ÙŠØ´ØªØ± ÙŠØ§ Ù…Ø³Ø§ÙˆÙŠ ${formatCost(manualCost)}) ÙŠØ§ÙØª Ù†Ø´Ø¯.`;
                showMessage('Ø®Ø·Ø§: Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù‡Ù†Ø¯Ø³ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÙŠØ·.', 'error');
                return;
            }
            
            const assignedEngineer = eligibleEngineers[0];
            const assignedEngineerRef = doc(ENGINEER_COLLECTION, assignedEngineer.id);
            
            let resultText = '';

            await runTransaction(db, async (transaction) => {
                
                transaction.update(assignedEngineerRef, {
                    debt: increment(manualCost),
                    lastAssignedProject: clientName,
                });
                
                const newProject = {
                    jobType: jobType,
                    cost: manualCost,
                    area: projectArea,
                    clientName: clientName,
                    organization: organization,
                    engineerId: assignedEngineer.id,
                    engineerName: assignedEngineer.name,
                    engineerRank: assignedEngineer.rank,
                    userId: ADMIN_UID, // Ù…Ø§Ù„Ú©ÙŠØª Ù¾Ø±ÙˆÚ˜Ù‡
                    assignedAt: serverTimestamp(),
                };
                transaction.set(doc(PROJECTS_COLLECTION), newProject);

                resultText = `Ú©Ø§Ø± Ø¨Ù‡ Ù…Ù‡Ù†Ø¯Ø³ ${assignedEngineer.name} (${assignedEngineer.rank}) Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯. Ø¨Ø¯Ù‡ÙŠ Ø§ÙØ²Ø§ÙŠØ´ ÙŠØ§ÙØª Ø¨Ù‡ Ù…ÙŠØ²Ø§Ù† ${formatCost(manualCost)}.`;
            });

            const resultDiv = document.getElementById('assignmentResult');
            resultDiv.classList.remove('hidden', 'border-r-4', 'border-red-500');
            resultDiv.classList.add('border-r-4', 'border-green-500');
            document.getElementById('resultText').textContent = resultText;
            
            showMessage('Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.', 'success');
            document.getElementById('assignProjectForm').reset();
            renderDynamicInputs(null);
            
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡ (ØªØ±Ø§Ú©Ù†Ø´): ", error);
            showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡. Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÙŠ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ÙŠØ§ Ù…Ø´Ú©Ù„ Ø´Ø¨Ú©Ù‡ Ø§Ø³Øª.', 'error');
        }
    });
    
    
    // Reset Quota (Single Engineer)
    async function resetEngineerQuota(engineerId, engineerName) {
        // Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÙŠ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª
        if (!isAuthReady || !isCurrentUserAdmin()) {
            showMessage('Ø¯Ø³ØªØ±Ø³ÙŠ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÙŠ ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ø±Ø§ Ù†Ø¯Ø§Ø±ÙŠØ¯.', 'error');
            closeModal('confirmationModal');
            return;
        }
        
        const engineerRef = doc(ENGINEER_COLLECTION, engineerId);
        
        try {
            await updateDoc(engineerRef, {
                debt: 0,
                lastResetAt: serverTimestamp(),
            });
            showMessage(`Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ ${engineerName} Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯.`, 'success');
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø³Ù‡Ù…ÙŠÙ‡: ", error);
            showMessage(`Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ ${engineerName}.`, 'error');
        } finally {
            closeModal('confirmationModal');
        }
    }
    
    // Reset All Quotas
    async function resetAllQuotas() {
        // Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÙŠ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª
        if (!isAuthReady || !isCurrentUserAdmin()) {
            showMessage('Ø¯Ø³ØªØ±Ø³ÙŠ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÙŠ ØªØ³ÙˆÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ Ø¨Ø¯Ù‡ÙŠ Ø±Ø§ Ù†Ø¯Ø§Ø±ÙŠØ¯.', 'error');
            closeModal('confirmationModal');
            return;
        }
        
        closeModal('confirmationModal');
        showMessage('Ø¯Ø± Ø­Ø§Ù„ ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†...', 'info');

        try {
            const batch = writeBatch(db);
            let count = 0;
            
            for (const id in allEngineersMap) {
                const eng = allEngineersMap[id];
                if (eng.debt > 0) {
                    const engineerRef = doc(ENGINEER_COLLECTION, id);
                    batch.update(engineerRef, {
                        debt: 0,
                        lastResetAt: serverTimestamp(),
                    });
                    count++;
                }
            }
            
            if (count > 0) {
                 await batch.commit();
                 showMessage(`${count} Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªØ³ÙˆÙŠÙ‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø² Ø´Ø¯.`, 'success');
            } else {
                 showMessage('Ø¨Ø¯Ù‡ÙŠ Ø¨Ø±Ø§ÙŠ ØªØ³ÙˆÙŠÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª.', 'info');
            }
            
        } catch (error) {
             console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ Ø³Ù‡Ù…ÙŠÙ‡â€ŒÙ‡Ø§: ", error);
             showMessage('Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ. Ø¹Ù…Ù„ÙŠØ§Øª Ù„ØºÙˆ Ø´Ø¯.', 'error');
        }
    }
    
    
    // ====================================================================
    // === MODAL & REPORTING FUNCTIONS ===
    // ====================================================================

    window.showConfirmation = function(action, id = null, name = null) {
        // Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÙŠ Ø­ØªÙŠ Ø¨Ø±Ø§ÙŠ Ù†Ù…Ø§ÙŠØ´ Modal ØªØ³ÙˆÙŠÙ‡
        if (!isCurrentUserAdmin() && (action === 'resetQuota' || action === 'resetAllQuotas')) {
             showMessage('Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÙŠ Ø§Ø¯Ù…ÙŠÙ† Ø¨Ø±Ø§ÙŠ Ø§ÙŠÙ† Ø§Ù‚Ø¯Ø§Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÙŠØ¯.', 'error');
             return;
        }
        
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmAcceptBtn = document.getElementById('confirmAcceptBtn');
        
        openModal('confirmationModal');
        
        if (action === 'resetQuota') {
            confirmModalTitle.textContent = `ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ ${name}`;
            confirmModalMessage.innerHTML = `Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ **${name}** (Ø¨Ø§ Ù…Ø¨Ù„Øº ${formatCost(allEngineersMap[id]?.debt || 0)}) ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø§Ùˆ ØµÙØ± Ø´ÙˆØ¯ØŸ`;
            confirmAcceptBtn.onclick = () => resetEngineerQuota(id, name);
            confirmAcceptBtn.textContent = 'ØªØ³ÙˆÙŠÙ‡ Ú©Ù†';
        } else if (action === 'resetAllQuotas') {
            confirmModalTitle.textContent = 'ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ Ø³Ù‡Ù…ÙŠÙ‡â€ŒÙ‡Ø§';
            confirmModalMessage.textContent = 'Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ø¨Ø¯Ù‡ÙŠ ØªÙ…Ø§Ù… Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†ÙŠ Ú©Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø± Ù‡Ø³ØªÙ†Ø¯ØŒ ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¢Ù†â€ŒÙ‡Ø§ ØµÙØ± Ø´ÙˆØ¯ØŸ Ø§ÙŠÙ† Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÙŠØ± Ø§Ø³Øª.';
            confirmAcceptBtn.onclick = resetAllQuotas;
            confirmAcceptBtn.textContent = 'ØªØ£ÙŠÙŠØ¯ ØªØ³ÙˆÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ';
        }
    }
    
    window.showEngineerProjects = async function(engineerId, engineerName) {
        openModal('detailsModal');
        modalTitle
