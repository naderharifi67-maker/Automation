<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ï¸ Ù…Ø¯ÙŠØ±ÙŠØª Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø¯Ø§Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Tahoma, Arial, sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .gradient-bg {
            /* ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØªØ± */
            background: linear-gradient(135deg, #0f3d6c 0%, #2563eb 100%);
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .modal-container {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        /* Style to hide non-active views */
        .view-container {
            min-height: 400px; /* Ensure content doesn't jump */
        }
        .hidden-view {
            display: none;
        }
        /* Print Styles: Critical for clean printouts */
        @media print {
            /* Hide elements not needed in print */
            .print\:hidden, .modal-container:not(#printReportModal), .card, .gradient-bg, .footer-buttons {
                display: none !important;
            }
            body, html {
                margin: 0;
                padding: 0;
                background: white;
                color: black;
            }
            #printReportModal {
                display: flex !important;
                position: static;
                background: white !important;
                height: auto;
                width: 100%;
                max-width: none;
            }
            #reportContentContainer {
                max-width: 100%;
                width: 100%;
                height: auto;
                box-shadow: none;
                padding: 0;
                border: none;
            }
            #printReportArea {
                overflow: visible !important;
                padding: 0;
            }
            .report-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
                border: 1px solid #ccc;
            }
            .report-table thead, .report-table tfoot {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .report-table thead th {
                background-color: #dbeafe !important;
                color: #1e3a8a !important; /* Darker blue text */
            }
            .report-table tfoot td {
                background-color: #f3f4f6 !important;
                font-weight: bold;
            }
            .report-table th, .report-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: right;
                font-size: 14px; /* Slightly smaller for print */
            }
            /* Show content that was hidden in view */
            .print-only {
                display: block !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="gradient-bg text-white p-6 rounded-xl mb-8 card print:hidden">
            <h1 class="text-3xl font-bold mb-2">Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø¯Ø§Ø± ğŸ—ºï¸</h1>
            <p class="text-sm opacity-90">Ù…Ø¯ÙŠØ±ÙŠØª Ø³Ù‡Ù…ÙŠÙ‡ Ø§Ø¹ØªØ¨Ø§Ø±ÙŠ Ùˆ Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ùˆ Ù…Ø¯ÙŠØ±ÙŠØª Ø¨Ø¯Ù‡ÙŠ.</p>
        </header>

        <div id="messageBox" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center" role="alert"></div>

        <div class="flex flex-wrap justify-center gap-4 mb-8 print:hidden">
            <button onclick="showView('addEngineerModal')"
                    class="bg-green-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯
            </button>
            <button onclick="showView('assignProjectModal')"
                    class="bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÙŠØ¯
            </button>
            <button onclick="showView('dashboardView')"
                    class="bg-gray-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-gray-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†
            </button>
            <button onclick="showMonthlyReport()"
                    class="bg-purple-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-purple-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø¢Ù…Ø§Ø± Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡
            </button>
        </div>

        <div id="contentArea" class="view-container">

            <div id="addEngineerModal" class="bg-white p-6 rounded-xl card hidden-view">
                <h3 class="text-2xl font-bold text-green-700 border-b pb-3 mb-4">Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯</h3>
                <form id="addEngineerForm" class="space-y-4 max-w-lg mx-auto">
                    <div>
                        <label for="engineerName" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÙŠ Ù…Ù‡Ù†Ø¯Ø³:</label>
                        <input type="text" id="engineerName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ÙŠ">
                    </div>
                    <div>
                        <label for="engineerRank" class="block text-sm font-medium text-gray-700 mb-1">Ù¾Ø§ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠ:</label>
                        <select id="engineerRank" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÙŠÙ‡...</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ Ø³Ù‡">Ù¾Ø§ÙŠÙ‡ Ø³Ù‡</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ">Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ ÙŠÚ©">Ù¾Ø§ÙŠÙ‡ ÙŠÚ©</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition duration-150 shadow-md">Ø°Ø®ÙŠØ±Ù‡ Ù…Ù‡Ù†Ø¯Ø³</button>
                </form>
            </div>


            <div id="assignProjectModal" class="bg-white p-6 rounded-xl card hidden-view">
                <h3 class="text-2xl font-bold text-blue-800 border-b pb-3 mb-4">Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <form id="assignProjectForm" class="space-y-5 max-w-lg mx-auto">
                    <div>
                        <label for="jobType" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ú©Ø§Ø± / Ù†Ù‚Ø´Ù‡:</label>
                        <select id="jobType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ú©Ø§Ø±...</option>
                            </select>
                    </div>

                    <div id="dynamicInputs" class="space-y-4 p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 text-center">Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯ ØªØ§ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.</p>
                    </div>
                    
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ù…ØªÙ‚Ø§Ø¶ÙŠ ØªÙ‡ÙŠÙ‡ Ù†Ù‚Ø´Ù‡:</label>
                        <input type="text" id="clientName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø´Ø±Ú©Øª ØªÙˆØ³Ø¹Ù‡ Ø´Ù‡Ø±">
                    </div>

                    <div id="assignmentResult" class="p-4 border-r-4 rounded-lg text-gray-800 hidden">
                        <h3 class="font-bold text-lg mb-2">Ù†ØªÙŠØ¬Ù‡ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±:</h3>
                        <p id="resultText" class="text-blue-700 font-semibold"></p>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 shadow-md">Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ùˆ Ù…Ø¹Ø±ÙÙŠ Ù…Ù‡Ù†Ø¯Ø³</button>
                </form>
            </div>


            <div id="dashboardView" class="bg-white p-6 rounded-xl card hidden-view">
                <h2 class="text-2xl font-semibold border-b pb-3 mb-4 text-gray-800">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† (Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)</h2>

                <div class="text-center p-4 text-gray-500" id="loadingMessage">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†...</div>
                <div id="engineerList" class="space-y-4">
                    </div>

                <div id="newQuotaButtonContainer" class="mt-8 pt-4 border-t flex justify-center hidden">
                    <button onclick="resetAllEngineersQuotas()" class="bg-red-700 text-white p-3 text-lg rounded-lg hover:bg-red-800 transition duration-150 shadow-2xl flex items-center font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v2M2 12A10 10 0 0 1 12 2a10 10 0 0 1 10 10M8 12l4 4 4-4" /></svg>
                        Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¨Ø±Ø§ÙŠ Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† (ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ)
                    </button>
                </div>
                
            </div>

        </div> </div>


    <div id="detailsModal" class="modal-container hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card max-w-2xl w-full p-6" role="dialog" aria-modal="true">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 id="modalTitle" class="text-xl md:text-2xl font-bold text-blue-800">Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§</h3>
                <button onclick="closeModal('detailsModal')" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="projectsList" class="max-h-96 overflow-y-auto space-y-3">
                <div class="text-center p-4 text-gray-500" id="modalLoadingMessage">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§...</div>
            </div>

            <div class="mt-6 border-t pt-4 text-left">
                <button onclick="closeModal('detailsModal')" class="bg-blue-600 text-white p-2 px-4 rounded-lg hover:bg-blue-700 transition">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <div id="printReportModal" class="modal-container hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div id="reportContentContainer" class="bg-white rounded-xl card max-w-6xl w-full p-6 h-[90vh] flex flex-col" role="dialog" aria-modal="true">
            <div class="flex justify-between items-start border-b pb-3 mb-4 flex-shrink-0 print:hidden">
                <h3 class="text-2xl font-bold text-gray-800">Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ú©Ø§Ø±</h3>
                <button onclick="closeModal('printReportModal')" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="printReportArea" class="flex-grow overflow-y-auto p-2">
                <div class="text-center p-8 text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÙŠ Ú¯Ø²Ø§Ø±Ø´...</div>
            </div>

            <div class="mt-4 border-t pt-4 flex justify-end gap-3 flex-shrink-0 footer-buttons print:hidden">
                <button onclick="window.printReport()" class="bg-green-600 text-white p-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H3v6h2v3h10v-3h2V7h-2V4h-3V3H8v1H5zm0 1h2v2H5V5zm10 0v2h-2V5h2zM5 14v-2h10v2H5zm10 2v-2h-2v2h2zM5 16h2v-2H5v2z" clip-rule="evenodd"/></svg>
                    Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´
                </button>
                <button onclick="closeModal('printReportModal')" class="bg-gray-500 text-white p-2 px-4 rounded-lg hover:bg-gray-600 transition">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal-container hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card max-w-sm w-full p-6" role="alertdialog" aria-modal="true">
            <h3 id="confirmModalTitle" class="text-xl font-bold text-red-700 border-b pb-2 mb-4">ØªØ§ÙŠÙŠØ¯ Ø¹Ù…Ù„ÙŠØ§Øª</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancelBtn" onclick="closeModal('confirmationModal')" class="bg-gray-300 text-gray-800 p-2 px-4 rounded-lg hover:bg-gray-400 transition">Ø§Ù†ØµØ±Ø§Ù</button>
                <button id="confirmAcceptBtn" class="bg-red-600 text-white p-2 px-4 rounded-lg hover:bg-red-700 transition">ØªØ§ÙŠÙŠØ¯ Ùˆ Ø§Ø¬Ø±Ø§</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, runTransaction, query, where, getDocs, increment, writeBatch, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG OBJECT
        const firebaseConfig = { // Ù†Ø§Ù…â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ¶ÙˆØ­ Ø¨Ù‡ØªØ±
            apiKey: "AIzaSyChV9mCptF4qybDn_yaOhmSz-KI3LhtDEQ",
            authDomain: "database-erjakar.firebaseapp.com",
            projectId: "database-erjakar",
            storageBucket: "database-erjakar.firebasestorage.app",
            messagingSenderId: "1056379437698",
            appId: "1:1056379437698:web:2a6bffc8ea0f1949436a9b",
            measurementId: "G-NS5ZPEFXD8"
        };
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±Ø§Ø³Ø±ÛŒ ÙØ§ÛŒØ±Ø¨ÛŒØ³
        // setLogLevel('debug'); // Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù†ÛŒØ§Ø²ÛŒ Ù†ÛŒØ³Øª
        
        let app, db, auth, userId = null;
        let isAuthReady = false;
        
        // --- Static Data ---

        // Ù…Ø¨Ø§Ù„Øº Ù¾ÙŠØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÙŠ Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ø± (Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)
        const PROJECT_COSTS = {
            'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': 1,
            'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': 2,
            'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': 4, 
        };
        
        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÙŠ Ù…Ø¯ÙŠØ±ÙŠØª ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ Ù…ØªØºÙŠØ±
        const JOB_DETAILS = {
            'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
            'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ú©Ù„ Ø²ÙŠØ± Ø¨Ù†Ø§ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
            'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' }, 
        };

        // Ø³Ù‚Ù Ø³Ù‡Ù…ÙŠÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÙŠÙ‡ (Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)
        const RANK_QUOTAS = {
            'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 10,
            'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 15,
            'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 20,
        };
        
        // Ø§ÙˆÙ„ÙˆÙŠØª Ø¹Ø¯Ø¯ÙŠ Ù¾Ø§ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø±Ø§ÙŠ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÙŠ (Ø¨ÙŠØ´ØªØ± = Ø§ÙˆÙ„ÙˆÙŠØª Ø¨Ø§Ù„Ø§ØªØ±)
        const RANK_PRIORITY = {
            'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 3,
            'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 2,
            'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 1,
        };

        // Ø§Ø±Ú¯Ø§Ù†â€ŒÙ‡Ø§ÙŠ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø¨Ø±Ø§ÙŠ Ù†Ù‚Ø´Ù‡â€ŒÙ‡Ø§ÙŠ UTM
        const UTM_ORGANIZATIONS = [
            'Ø§ÙˆÙ‚Ø§Ù Ùˆ Ø§Ù…ÙˆØ±Ø®ÙŠØ±ÙŠÙ‡',
            'Ø¨Ù†ÙŠØ§Ø¯ Ù…Ø³Ú©Ù†',
            'Ø¬Ù‡Ø§Ø¯ Ú©Ø´Ø§ÙˆØ±Ø²ÙŠ',
            'Ù…Ù†Ø§Ø¨Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ',
            'Ø§Ø¯Ø§Ø±Ù‡ Ø«Ø¨Øª Ø§Ø³Ù†Ø§Ø¯ Ùˆ Ø§Ù…Ù„Ø§Ú©',
            'Ù…ÙŠØ±Ø§Ø« ÙØ±Ù‡Ù†Ú¯ÙŠ',
            'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' 
        ];
        
        // Ù…Ø³ÙŠØ±Ù‡Ø§ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
        let ENGINEER_COLLECTION, PROJECTS_COLLECTION;
        let allEngineersMap = {}; // Cache for engineer details
        let allProjects = []; // Cache for all projects (used in reporting)

        // Ù…Ø±Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± Modal
        let detailsModalRef, modalTitleRef, projectsListRef, modalLoadingMessageRef;

        // --- Utility Functions ---
        
        // Modal Open/Close Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÙŠØ´ Ùˆ Ù…Ø®ÙÙŠ Ú©Ø±Ø¯Ù† ÙˆÙŠÙˆÙ‡Ø§
        function showView(viewId) {
            const views = ['addEngineerModal', 'assignProjectModal', 'dashboardView'];
            views.forEach(id => {
                const view = document.getElementById(id);
                if (view) {
                    if (id === viewId) {
                        view.classList.remove('hidden-view');
                    } else {
                        view.classList.add('hidden-view');
                    }
                }
            });

            // Ø§Ú¯Ø± Ù†Ù…Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨ÙˆØ¯ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ… Ú©Ù‡ Ù„ÛŒØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù†ÛŒØ² Scroll Ø´ÙˆØ¯.
            if (viewId === 'dashboardView') {
                document.getElementById('dashboardView').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        window.closeModal = closeModal;
        window.showView = showView; // Expose to global scope for button clicks

        // ØªØ§Ø¨Ø¹ ÙØ±Ù…Øª Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†
        function formatCost(cost) {
            if (cost === undefined || cost === null) return 'N/A';
            return parseFloat(cost).toLocaleString('fa') + ' Ù….Øª';
        }

        // ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
        function toJalali(timestamp) {
            if (!timestamp) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
            const date = timestamp.toDate();
            return new Intl.DateTimeFormat('fa-IR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric'
            }).format(date);
        }

        // --- Custom Confirmation Modal Logic (Unchanged) ---
        let confirmCallback = null;

        function showConfirmationModal(title, message, callback) {
            const modal = document.getElementById('confirmationModal');
            const titleEl = document.getElementById('confirmModalTitle');
            const messageEl = document.getElementById('confirmModalMessage');
            const acceptBtn = document.getElementById('confirmAcceptBtn');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.remove('hidden');
            
            confirmCallback = callback;

            // This clone/replace technique prevents multiple event listeners from stacking up
            const newAcceptBtn = acceptBtn.cloneNode(true);
            acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);

            newAcceptBtn.addEventListener('click', () => {
                closeModal('confirmationModal');
                if (confirmCallback) {
                    confirmCallback(true);
                }
            });

            document.getElementById('confirmCancelBtn').onclick = () => {
                closeModal('confirmationModal');
                // We don't call the callback with false, as the default is just to stop the action.
            };
        }
        window.showConfirmationModal = showConfirmationModal;


        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÙŠØ´ Ù¾ÙŠØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± (Unchanged)
        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;

            let bgColor, borderColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 text-green-800';
                    borderColor = 'border-green-600';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 text-red-800';
                    borderColor = 'border-red-600';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-100 text-blue-800';
                    borderColor = 'border-blue-600';
                    break;
            }

            box.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center border-r-8 ${bgColor} ${borderColor}`;
            box.classList.remove('hidden');

            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÙŠ ÙˆØ¶Ø¹ÙŠØª Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ù„ÙŠ (Ø¢ÙŠØ§ Ù‡Ù…Ù‡ Ù¾Ø± Ù‡Ø³ØªÙ†Ø¯ØŸ)
        function checkGlobalQuotaStatus(engineers) {
            if (engineers.length === 0) return false;
            // Ø§Ú¯Ø± Ø­ØªÛŒ ÛŒÚ© Ù…Ù‡Ù†Ø¯Ø³ Ø³Ù‡Ù…ÛŒÙ‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ù…Ø«Ø¨Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø³ÛŒØ³ØªÙ… Ù¾Ø± Ù†ÛŒØ³Øª.
            const hasFreeQuota = engineers.some(eng => (eng.maxQuota - eng.usedQuota) > 0.1); // Small buffer for float math
            return !hasFreeQuota; // Ø§Ú¯Ø± Ù‡ÛŒÚ†Ú©Ø³ Ø³Ù‡Ù…ÛŒÙ‡ Ø¢Ø²Ø§Ø¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§ÛŒØ¯ Ø¸Ø§Ù‡Ø± Ø´ÙˆØ¯ (True)
        }


        // Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† (Dashboard)
        function renderEngineers(engineers) {
            const listContainer = document.getElementById('engineerList');
            const loadingMessage = document.getElementById('loadingMessage'); 
            const newQuotaButtonContainer = document.getElementById('newQuotaButtonContainer');

            listContainer.innerHTML = '';
            if (loadingMessage) {
                loadingMessage.classList.add('hidden');
            }

            if (engineers.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">Ù‡Ù†ÙˆØ² Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                newQuotaButtonContainer.classList.add('hidden'); 
                return;
            }

            // Ù…Ø±ØªØ¨ Ø³Ø§Ø²ÛŒ: Ù¾Ø§ÛŒÙ‡ Ø¨Ø§Ù„Ø§ØªØ± + Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø³Ù‡Ù…ÛŒÙ‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ (Ú©Ù…ØªØ±ÛŒÙ† Ø¨Ø¯Ù‡ÛŒ)
            const sortedEngineers = engineers.sort((a, b) => {
                const rankA = RANK_PRIORITY[a.rank] || 0;
                const rankB = RANK_PRIORITY[b.rank] || 0;
                if (rankB !== rankA) {
                    return rankB - rankA; // Higher rank first
                }
                const remainingA = a.maxQuota - a.usedQuota;
                const remainingB = b.maxQuota - b.usedQuota;
                return remainingB - remainingA; // Higher remaining first (least debt)
            });


            sortedEngineers.forEach(eng => {
                const remaining = eng.maxQuota - eng.usedQuota;
                const debt = Math.max(0, -remaining); 
                // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨ØµØ±ÛŒØŒ Ø¯Ø±ØµØ¯ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù‡Ù…ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                const percentageUsed = (eng.usedQuota / eng.maxQuota) * 100;

                let quotaStatusHTML;
                let progressColor;
                
                if (remaining >= 0) {
                    quotaStatusHTML = `<p class="text-md font-semibold ${remaining > 0 ? 'text-green-700' : 'text-yellow-700'} mt-1">
                                            Ø³Ù‡Ù…ÙŠÙ‡ Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡: ${formatCost(remaining)}
                                          </p>`;
                    progressColor = percentageUsed < 95 ? 'bg-green-500' : 'bg-yellow-500';
                } else {
                    quotaStatusHTML = `<p class="text-md font-bold text-red-700 mt-1">
                                            Ø¨Ø¯Ù‡ÙŠ Ø³Ù‡Ù…ÙŠÙ‡ (Ù…Ø§Ø²Ø§Ø¯): ${formatCost(debt)}
                                          </p>`;
                    progressColor = 'bg-red-600';
                }

                // Logic for Quota Reset Button
                let resetButtonHTML = `
                    <button onclick="event.stopPropagation(); resetEngineerQuota('${eng.id}', '${eng.fullName.replace(/'/g, "\\'")}', ${eng.usedQuota}, ${eng.maxQuota})" 
                        class="bg-blue-500 text-white px-3 py-1 text-xs rounded-lg hover:bg-blue-600 transition duration-150 mt-2 ${debt > 0 ? 'bg-red-700 hover:bg-red-800' : ''}">
                        ${debt > 0 ? 'ØªÙ…Ø¯ÙŠØ¯ Ùˆ ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ' : 'ØªÙ…Ø¯ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡'}
                    </button>
                `;

                // Ø³Ø§Ø®Øª Ú©Ø§Ø±Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÙŠØª Ú©Ù„ÙŠÚ© Ø¨Ø±Ø§ÙŠ Ø¬Ø²Ø¦ÙŠØ§Øª
                const engineerCard = `
                    <div class="p-4 border rounded-xl bg-gray-50 flex items-start transition hover:shadow-lg hover:border-blue-500">
                        <div onclick="showEngineerDetails('${eng.id}', '${eng.fullName.replace(/'/g, "\\'")}')" class="flex-grow cursor-pointer">
                            <p class="font-bold text-lg text-blue-900">${eng.fullName} (<span class="text-sm font-normal">${eng.rank}</span>)</p>
                            <div class="flex flex-wrap text-sm text-gray-600 mt-1 space-x-4 space-x-reverse">
                                <span class="font-medium">Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ù„: ${formatCost(eng.maxQuota)}</span>
                                <span>Ù…ØµØ±Ù Ø´Ø¯Ù‡: ${formatCost(eng.usedQuota)}</span>
                            </div>
                            ${quotaStatusHTML}
                        </div>

                        <div class="w-1/3 min-w-[120px] mr-4 flex flex-col items-end">
                            <div class="h-2.5 bg-gray-200 rounded-full w-full">
                                <div class="progress-bar-fill h-2.5 rounded-full ${progressColor}" style="width: ${Math.min(100, percentageUsed).toFixed(0)}%;"></div>
                            </div>
                            <p class="text-xs text-right mt-1 text-gray-500">${Math.min(100, percentageUsed).toFixed(0)}% Ù…ØµØ±Ù</p>
                            <div class="reset-button-container">
                                ${resetButtonHTML}
                            </div>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', engineerCard);
            });
            
            // Ù†Ù…Ø§ÙŠØ´/Ø¹Ø¯Ù… Ù†Ù…Ø§ÙŠØ´ Ø¯Ú©Ù…Ù‡ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ù„ÙŠ
            const isGlobalQuotaExceeded = checkGlobalQuotaStatus(engineers);
            if (newQuotaButtonContainer) {
                if (isGlobalQuotaExceeded) {
                    newQuotaButtonContainer.classList.remove('hidden');
                } else {
                    newQuotaButtonContainer.classList.add('hidden');
                }
            }
        }
        
        // --- Dynamic Form Rendering (for Assignment View) ---
        
        function renderDynamicInputs(jobType) {
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = ''; 
            
            const jobDetail = JOB_DETAILS[jobType];
            
            if (!jobDetail) {
                 container.innerHTML = '<p class="text-sm text-gray-500 text-center">Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯ ØªØ§ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.</p>';
                 return;
            }

            // 1. Add Area Input if required
            if (jobDetail.isAreaRequired) {
                const areaInputHTML = `
                    <div class="area-input">
                        <label for="projectArea" class="block text-sm font-medium text-gray-700 mb-1">${jobDetail.label}</label>
                        <input type="number" step="1" min="1" id="projectArea" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: 120">
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', areaInputHTML);
            }

            // 2. Add Organization Dropdown ONLY if it's 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' (i.e., Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…)
            let relatedOrganization = jobDetail.organization;
            if (relatedOrganization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
                let optionsHtml = UTM_ORGANIZATIONS.map(org => `<option value="${org}">${org}</option>`).join('');
                const organizationDropdown = `
                    <div class="organization-select">
                        <label for="relatedOrganization" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡:</label>
                        <select id="relatedOrganization" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†...</option>
                            ${optionsHtml}
                        </select>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', organizationDropdown);
            } else if (relatedOrganization) {
                const fixedOrganizationInfo = `
                    <div class="p-2 bg-blue-50 border-r-4 border-blue-400 rounded-md text-sm text-gray-700">
                        <p class="font-semibold">Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡: ${relatedOrganization}</p>
                        <p class="text-xs">Ø§ÙŠÙ† Ù†ÙˆØ¹ Ù†Ù‚Ø´Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ ${relatedOrganization} Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ù…ÙŠâ€ŒØ´ÙˆØ¯.</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', fixedOrganizationInfo);
            }


            // 3. Always add Manual Cost Input (Required)
            const manualCostHTML = `
                <div class="manual-cost-input">
                    <label for="manualCost" class="block text-sm font-medium text-gray-700 mb-1">Ù‡Ø²ÙŠÙ†Ù‡ Ø¨ØµÙˆØ±Øª Ø¯Ø³ØªÙŠ (Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†):</label>
                    <input type="number" step="0.5" min="0.5" id="manualCost" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù‡Ø²ÙŠÙ†Ù‡ Ù†Ù‡Ø§ÙŠÙŠ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹: 2.5)">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', manualCostHTML);
            
            const manualCostInput = document.getElementById('manualCost');
            const defaultCost = PROJECT_COSTS[jobType];
            if (defaultCost !== undefined && manualCostInput) {
                manualCostInput.value = defaultCost;
            }
        }

        // --- Event Listeners for Dynamic Inputs ---
        
        document.getElementById('jobType').addEventListener('change', (e) => {
            const jobType = e.target.value;
            renderDynamicInputs(jobType); 
            document.getElementById('assignmentResult').classList.add('hidden'); // Reset assignment result
        });
        
        document.addEventListener('DOMContentLoaded', () => {
             // Populate Job Type dropdown on load
            const jobTypeSelect = document.getElementById('jobType');
            Object.keys(PROJECT_COSTS).forEach(jobType => {
                const option = document.createElement('option');
                option.value = jobType;
                option.textContent = jobType;
                jobTypeSelect.appendChild(option);
            });
        });

        // --- Details Modal Functionality ---

        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÙŠØ´ Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§ÙŠ Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ù‡ ÙŠÚ© Ù…Ù‡Ù†Ø¯Ø³
        async function showEngineerDetails(engineerId, engineerName) {
            
            const modal = detailsModalRef;
            const modalTitle = modalTitleRef;
            const projectsList = projectsListRef;
            const modalLoadingMessage = modalLoadingMessageRef;
            
            modalTitle.textContent = `Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§ÙŠ ${engineerName}`;
            projectsList.innerHTML = '';
            modalLoadingMessage.classList.remove('hidden');
            modal.classList.remove('hidden');

            try {
                // Fetch projects assigned to this engineer, ordered by latest
                const projectsQuery = query(
                    PROJECTS_COLLECTION,
                    where("engineerId", "==", engineerId),
                    // limit(50) // Optional: limit the number of displayed projects
                );
                
                const querySnapshot = await getDocs(projectsQuery);
                modalLoadingMessage.classList.add('hidden');

                if (querySnapshot.empty) {
                    projectsList.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">Ù‡Ù†ÙˆØ² Ù‡ÙŠÚ† Ú©Ø§Ø±ÙŠ Ø¨Ù‡ Ø§ÙŠÙ† Ù…Ù‡Ù†Ø¯Ø³ Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                    return;
                }

                let totalCost = 0;
                let projectsHtml = `<table class="min-w-full divide-y divide-gray-200 report-table">
                                    <thead class="bg-blue-100">
                                        <tr>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">#</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">Ù†ÙˆØ¹ Ú©Ø§Ø±</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">Ù…ØªÙ‚Ø§Ø¶ÙŠ</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">Ø§Ø±Ú¯Ø§Ù†</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">Ù‡Ø²ÙŠÙ†Ù‡ (Ù….Øª)</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-600 uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ø±Ø¬Ø§Ø¹</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">`;

                querySnapshot.docs.forEach((doc, index) => {
                    const project = doc.data();
                    totalCost += project.cost;

                    projectsHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-blue-700">${project.jobType}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${project.clientName}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${project.organization || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm font-bold text-red-600">${formatCost(project.cost)}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${toJalali(project.timestamp)}</td>
                        </tr>
                    `;
                });

                projectsHtml += `
                                    </tbody>
                                    <tfoot class="bg-gray-100">
                                        <tr>
                                            <td colspan="4" class="px-3 py-3 text-sm font-bold text-gray-900 text-left">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ù‡Ø²ÙŠÙ†Ù‡â€ŒÙ‡Ø§:</td>
                                            <td colspan="2" class="px-3 py-3 text-sm font-bold text-red-700">${formatCost(totalCost)}</td>
                                        </tr>
                                    </tfoot>
                                </table>`;
                
                projectsList.innerHTML = projectsHtml;


            } catch (error) {
                console.error("Error fetching project details: ", error);
                modalLoadingMessage.classList.add('hidden');
                projectsList.innerHTML = '<p class="text-center text-red-500 p-4 bg-red-50 rounded-lg">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯.</p>';
            }
        }
        window.showEngineerDetails = showEngineerDetails;

        // --- Main Functions (CRUD/Core Logic) ---

        /**
         * 1. Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯
         */
        document.getElementById('addEngineerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showMessage("Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÙŠØ¯ ØªØ§ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³ÙŠØ³ØªÙ… Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´ÙˆØ¯.", 'info');
                return;
            }

            const fullName = document.getElementById('engineerName').value.trim();
            const rank = document.getElementById('engineerRank').value;
            const maxQuota = RANK_QUOTAS[rank];

            if (!fullName || !rank || !maxQuota) {
                showMessage("Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÙŠ Ù¾Ø± Ú©Ù†ÙŠØ¯.", 'error');
                return;
            }

            try {
                await addDoc(ENGINEER_COLLECTION, {
                    fullName: fullName,
                    rank: rank,
                    maxQuota: maxQuota, // Total available quota in M.T
                    usedQuota: 0,       // Consumed quota in M.T
                    projectsCount: 0,
                    createdAt: new Date(),
                    createdBy: userId
                });

                showMessage(`Ù…Ù‡Ù†Ø¯Ø³ **${fullName}** Ø¨Ø§ Ù¾Ø§ÙŠÙ‡ **${rank}** Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø«Ø¨Øª Ø´Ø¯.`, 'success');
                document.getElementById('addEngineerForm').reset();
                showView('dashboardView'); // Navigate to dashboard after successful add

            } catch (error) {
                console.error("Error adding engineer: ", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯.", 'error');
            }
        });

        /**
         * ØªØ§Ø¨Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ØªØ±ÙŠÙ† Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø±Ø§ÙŠ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±
         */
        function findBestEngineer(cost) {
            // Filter engineers who haven't exceeded their quota + max 50% debt
            const availableEngineers = Object.values(allEngineersMap).filter(eng => {
                 // Check if the cost of the new project is within the maximum allowed debt (e.g., maxQuota * 1.5)
                 const maxAllowedUsage = eng.maxQuota * 1.5; // Example: Max 50% debt
                 return eng.usedQuota + cost <= maxAllowedUsage;
            });

            if (availableEngineers.length === 0) {
                return null;
            }

            // Sort by Priority:
            // 1. Higher Rank (Ù¾Ø§ÙŠÙ‡ ÙŠÚ© > Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ > Ù¾Ø§ÙŠÙ‡ Ø³Ù‡)
            // 2. Least consumed percentage of quota (closer to 0%)
            availableEngineers.sort((a, b) => {
                const rankA = RANK_PRIORITY[a.rank] || 0;
                const rankB = RANK_PRIORITY[b.rank] || 0;
                
                if (rankB !== rankA) {
                    return rankB - rankA; // Higher rank first
                }
                
                // Calculate consumption percentage
                const usagePercentageA = (a.usedQuota / a.maxQuota) * 100;
                const usagePercentageB = (b.usedQuota / b.maxQuota) * 100;
                
                return usagePercentageA - usagePercentageB; // Lower percentage (less consumed) first
            });

            return availableEngineers[0];
        }


        /**
         * 2. Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÙŠØ¯
         */
        document.getElementById('assignProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showMessage("Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÙŠØ¯ ØªØ§ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³ÙŠØ³ØªÙ… Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´ÙˆØ¯.", 'info');
                return;
            }

            const jobType = document.getElementById('jobType').value;
            const clientName = document.getElementById('clientName').value.trim();
            const projectAreaInput = document.getElementById('projectArea');
            const relatedOrganizationSelect = document.getElementById('relatedOrganization');
            const manualCostInput = document.getElementById('manualCost');
            
            const area = projectAreaInput ? parseFloat(projectAreaInput.value) : null;
            const cost = manualCostInput ? parseFloat(manualCostInput.value) : null;
            let organization = JOB_DETAILS[jobType].organization;

            if (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' && relatedOrganizationSelect) {
                organization = relatedOrganizationSelect.value;
            }

            if (!jobType || !clientName || isNaN(cost) || cost <= 0 || (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' && !relatedOrganizationSelect.value)) {
                showMessage("Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÙŠ ÙˆØ§Ø±Ø¯ Ú©Ù†ÙŠØ¯.", 'error');
                return;
            }
            
            const resultBox = document.getElementById('assignmentResult');
            const resultText = document.getElementById('resultText');

            // 1. Find Best Engineer
            const bestEngineer = findBestEngineer(cost);

            if (!bestEngineer) {
                resultText.className = 'text-red-700 font-bold';
                resultText.textContent = `Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÙŠ (Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡ ÙŠØ§ Ø¨Ø¯Ù‡ÙŠ Ù…Ø¬Ø§Ø²) Ù¾ÙŠØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø±Ø§ ØªÙ…Ø¯ÙŠØ¯ Ú©Ù†ÙŠØ¯.`;
                resultBox.classList.remove('hidden');
                showMessage("Ø³ÙŠØ³ØªÙ… Ø§Ø±Ø¬Ø§Ø¹ Ù…ÙˆÙ‚Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯. Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ù„ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù¾Ø± Ø§Ø³Øª.", 'error');
                return;
            }
            
            // 2. Perform Transaction to update engineer and add project atomically
            const engineerRef = doc(db, 'engineers', bestEngineer.id);
            let assignedProject = null;

            try {
                await runTransaction(db, async (transaction) => {
                    // a. Read current engineer data
                    const engineerDoc = await transaction.get(engineerRef);
                    if (!engineerDoc.exists()) {
                        throw "Engineer document does not exist!";
                    }

                    const currentUsedQuota = engineerDoc.data().usedQuota;
                    const newUsedQuota = currentUsedQuota + cost;
                    const newProjectsCount = engineerDoc.data().projectsCount + 1;

                    // b. Update engineer usedQuota and projectsCount
                    transaction.update(engineerRef, {
                        usedQuota: newUsedQuota,
                        projectsCount: newProjectsCount,
                        lastAssignment: new Date()
                    });

                    // c. Add new project record
                    const projectData = {
                        engineerId: bestEngineer.id,
                        engineerName: bestEngineer.fullName,
                        jobType: jobType,
                        clientName: clientName,
                        cost: cost,
                        organization: organization,
                        area: area,
                        timestamp: new Date()
                    };
                    
                    // We can't use addDoc inside a transaction, must use a DocumentReference
                    const newProjectRef = doc(PROJECTS_COLLECTION);
                    transaction.set(newProjectRef, projectData);

                    assignedProject = projectData;
                });
                
                // 3. Show Success Message
                if (assignedProject) {
                    const remainingQuota = bestEngineer.maxQuota - (bestEngineer.usedQuota + cost);
                    const remainingQuotaText = remainingQuota >= 0 
                        ? `<span class="text-green-700">${formatCost(remainingQuota)} Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡ Ø§Ø³Øª.</span>`
                        : `<span class="text-red-700 font-bold">${formatCost(Math.abs(remainingQuota))} Ø¨Ø¯Ù‡Ú©Ø§Ø± Ø´Ø¯.</span>`;
                        
                    resultText.className = 'text-blue-700 font-semibold';
                    resultText.innerHTML = `
                        Ú©Ø§Ø± **${jobType}** Ø¨Ù‡ Ù…Ù‡Ù†Ø¯Ø³ **${bestEngineer.fullName}** Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯.<br>
                        Ù‡Ø²ÙŠÙ†Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡: **${formatCost(cost)}**.<br>
                        Ø³Ù‡Ù…ÙŠÙ‡ Ø§ÙŠØ´Ø§Ù† Ù¾Ø³ Ø§Ø² Ø§Ø±Ø¬Ø§Ø¹: ${remainingQuotaText}
                    `;
                    resultBox.classList.remove('hidden');
                    showMessage(`Ú©Ø§Ø± Ø¨Ù‡ **${bestEngineer.fullName}** Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯.`, 'success');
                    document.getElementById('assignProjectForm').reset();
                    renderDynamicInputs(null); // Clear dynamic inputs

                    // Focus back to job type selection for next assignment
                    document.getElementById('jobType').focus();
                }


            } catch (error) {
                console.error("Transaction failed: ", error);
                showMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±: ${error}`, 'error');
            }

        });
        
        // --- Quota Management Functions ---
        
        /**
         * ØªÙ…Ø¯ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ ÙŠÚ© Ù…Ù‡Ù†Ø¯Ø³
         */
        async function resetEngineerQuota(engineerId, engineerName, usedQuota, maxQuota) {
            
            showConfirmationModal(
                "ØªÙ…Ø¯ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³",
                `Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù†ÙŠØ¯ Ú©Ù‡ Ù…ÙŠâ€ŒØ®ÙˆØ§Ù‡ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ **${engineerName}** Ø±Ø§ ØªÙ…Ø¯ÙŠØ¯ Ú©Ù†ÙŠØ¯ØŸ
                 Ø¨Ø¯Ù‡ÙŠ Ù‚Ø¨Ù„ÙŠ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯) Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ **${formatCost(Math.max(0, usedQuota - maxQuota))}** ØªØ³ÙˆÙŠÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.`,
                async (confirmed) => {
                    if (confirmed) {
                        const engineerRef = doc(db, 'engineers', engineerId);
                        try {
                            // Use transaction for atomic update
                            await runTransaction(db, async (transaction) => {
                                const engineerDoc = await transaction.get(engineerRef);
                                if (!engineerDoc.exists()) {
                                    throw "Engineer document does not exist!";
                                }
                                
                                // Reset usedQuota to 0
                                transaction.update(engineerRef, {
                                    usedQuota: 0,
                                    lastReset: new Date()
                                });
                            });

                            showMessage(`Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ **${engineerName}** Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªÙ…Ø¯ÙŠØ¯ Ùˆ Ø¨Ø¯Ù‡ÙŠ ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯.`, 'success');

                        } catch (error) {
                            console.error("Error resetting quota: ", error);
                            showMessage("Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯.", 'error');
                        }
                    }
                }
            );
        }
        window.resetEngineerQuota = resetEngineerQuota;


        /**
         * ØªÙ…Ø¯ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†
         */
        function resetAllEngineersQuotas() {
            showConfirmationModal(
                "ØªÙ…Ø¯ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ",
                "Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù†ÙŠØ¯ Ú©Ù‡ Ù…ÙŠâ€ŒØ®ÙˆØ§Ù‡ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ **ØªÙ…Ø§Ù… Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†** Ø±Ø§ Ø¨Ù‡ ØµÙØ± Ø¨Ø±Ø³Ø§Ù†ÙŠØ¯ Ùˆ Ø¨Ø¯Ù‡ÙŠâ€ŒÙ‡Ø§ÙŠ Ø¢Ù†Ø§Ù† Ø±Ø§ ØªØ³ÙˆÙŠÙ‡ Ú©Ù†ÙŠØ¯ØŸ Ø§ÙŠÙ† ÙŠÚ© Ø§Ù‚Ø¯Ø§Ù… ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.",
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            const batch = writeBatch(db);
                            const engineersToReset = Object.values(allEngineersMap).filter(eng => eng.usedQuota > 0.1); // Only reset those with consumption

                            if (engineersToReset.length === 0) {
                                showMessage("Ø³Ù‡Ù…ÙŠÙ‡ ØªÙ…Ø§Ù… Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù‚Ø¨Ù„Ø§Ù‹ ØµÙØ± Ø´Ø¯Ù‡ Ø§Ø³Øª.", 'info');
                                return;
                            }
                            
                            engineersToReset.forEach(eng => {
                                const engineerRef = doc(db, 'engineers', eng.id);
                                batch.update(engineerRef, {
                                    usedQuota: 0,
                                    lastReset: new Date()
                                });
                            });

                            await batch.commit();
                            showMessage(`Ø³Ù‡Ù…ÙŠÙ‡ ${engineersToReset.length} Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªÙ…Ø¯ÙŠØ¯ Ùˆ Ø¨Ø¯Ù‡ÙŠâ€ŒÙ‡Ø§ÙŠØ´Ø§Ù† ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯.`, 'success');

                        } catch (error) {
                            console.error("Error resetting all quotas: ", error);
                            showMessage("Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯.", 'error');
                        }
                    }
                }
            );
        }
        window.resetAllEngineersQuotas = resetAllEngineersQuotas;

        // --- Reporting Functions (Monthly Report) ---

        /**
         * Ù†Ù…Ø§ÙŠØ´ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡
         */
        async function showMonthlyReport() {
            document.getElementById('printReportModal').classList.remove('hidden');
            const reportArea = document.getElementById('printReportArea');
            reportArea.innerHTML = '<div class="text-center p-8 text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÙŠ Ú¯Ø²Ø§Ø±Ø´...</div>';

            try {
                // Fetch all projects (or filter for the current month if performance is an issue)
                // For simplicity, we use the cached 'allProjects' which is updated by the onSnapshot listener below.
                const projects = allProjects;
                const engineers = Object.values(allEngineersMap);

                if (projects.length === 0) {
                    reportArea.innerHTML = '<div class="text-center p-8 text-gray-500">Ù‡ÙŠÚ† Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±ÙŠ Ø¯Ø± Ø³ÙŠØ³ØªÙ… Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
                    return;
                }

                // 1. Group Projects by Engineer
                const engineerProjects = projects.reduce((acc, project) => {
                    if (!acc[project.engineerId]) {
                        acc[project.engineerId] = {
                            name: project.engineerName,
                            totalCost: 0,
                            projectsCount: 0,
                            projects: []
                        };
                    }
                    acc[project.engineerId].totalCost += project.cost;
                    acc[project.engineerId].projectsCount++;
                    acc[project.engineerId].projects.push(project);
                    return acc;
                }, {});

                // 2. Calculate Totals & Engineer Summary
                let grandTotalCost = 0;
                let grandTotalProjects = projects.length;

                let summaryHtml = `<div class="p-4 mb-6 bg-blue-50 border-r-4 border-blue-500 print-only">
                                    <h4 class="text-lg font-bold text-blue-800 mb-2">Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±:</h4>
                                    <p>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ù‡Ø§ÙŠ Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯Ù‡: **${grandTotalProjects.toLocaleString('fa')}** Ù…ÙˆØ±Ø¯</p>
                                    <p>Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯Ù‡: **${formatCost(projects.reduce((sum, p) => sum + p.cost, 0))}**</p>
                                    <p>ØªØ§Ø±ÙŠØ® Ú¯Ø²Ø§Ø±Ø´: **${toJalali(new Date())}**</p>
                                </div>
                                <h4 class="text-xl font-bold text-gray-800 mt-4 mb-4">Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†:</h4>
                                <table class="min-w-full divide-y divide-gray-200 report-table mb-8">
                                    <thead class="bg-blue-200">
                                        <tr>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-700 uppercase tracking-wider">Ù…Ù‡Ù†Ø¯Ø³</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-700 uppercase tracking-wider">Ù¾Ø§ÙŠÙ‡</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-700 uppercase tracking-wider">Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ù„ (Ù….Øª)</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-700 uppercase tracking-wider">Ù…ØµØ±Ù Ø¬Ø§Ø±ÙŠ (Ù….Øª)</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-700 uppercase tracking-wider">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-700 uppercase tracking-wider">Ú©Ù„ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª (Ù….Øª)</th>
                                            <th class="px-3 py-2 text-xs font-medium text-gray-700 uppercase tracking-wider">Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡/Ø¨Ø¯Ù‡ÙŠ (Ù….Øª)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">`;

                // Combine Engineer data with Project summary
                const engineerSummary = engineers.map(eng => {
                    const projectData = engineerProjects[eng.id] || { totalCost: 0, projectsCount: 0 };
                    grandTotalCost += projectData.totalCost;
                    const remaining = eng.maxQuota - eng.usedQuota;

                    return {
                        ...eng,
                        totalProjectCost: projectData.totalCost,
                        totalProjects: projectData.projectsCount,
                        remaining: remaining
                    };
                }).sort((a, b) => (RANK_PRIORITY[b.rank] || 0) - (RANK_PRIORITY[a.rank] || 0));


                engineerSummary.forEach(eng => {
                    const remainingColor = eng.remaining >= 0 ? 'text-green-600' : 'text-red-700';
                    summaryHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${eng.fullName}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${eng.rank}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${formatCost(eng.maxQuota)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${formatCost(eng.usedQuota)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${eng.totalProjects.toLocaleString('fa')}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-bold text-blue-700">${formatCost(eng.totalProjectCost)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-bold ${remainingColor}">${formatCost(eng.remaining)}</td>
                        </tr>
                    `;
                });

                summaryHtml += `
                                    </tbody>
                                    <tfoot class="bg-gray-100">
                                        <tr>
                                            <td colspan="4" class="px-3 py-2 text-sm font-bold text-gray-900 text-left">Ø¬Ù…Ø¹ Ú©Ù„:</td>
                                            <td class="px-3 py-2 text-sm font-bold text-gray-900">${grandTotalProjects.toLocaleString('fa')}</td>
                                            <td class="px-3 py-2 text-sm font-bold text-blue-900">${formatCost(grandTotalCost)}</td>
                                            <td class="px-3 py-2 text-sm font-bold text-gray-900">N/A</td>
                                        </tr>
                                    </tfoot>
                                </table>`;
                
                reportArea.innerHTML = summaryHtml;

            } catch (error) {
                console.error("Error generating report: ", error);
                reportArea.innerHTML = '<div class="text-center p-8 text-red-500">Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÙŠØ¯ Ú¯Ø²Ø§Ø±Ø´.</div>';
            }
        }
        window.showMonthlyReport = showMonthlyReport;
        
        /**
         * ØªØ§Ø¨Ø¹ Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´ (Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ù‡ØªØ± Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§)
         */
        window.printReport = function() {
            window.print();
        };

        // --- Initialization and Real-time Listeners ---
        
        function initializeAppReferences() {
            // Initialize Firebase App
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Collection references (after auth is set, but we use a fixed structure)
            ENGINEER_COLLECTION = collection(db, "engineers");
            PROJECTS_COLLECTION = collection(db, "projects");

            // Cache Modal References
            detailsModalRef = document.getElementById('detailsModal');
            modalTitleRef = document.getElementById('modalTitle');
            projectsListRef = document.getElementById('projectsList');
            modalLoadingMessageRef = document.getElementById('modalLoadingMessage');
        }


        function setupRealtimeListeners() {
            // 1. Real-time listener for Engineers (Dashboard)
            onSnapshot(ENGINEER_COLLECTION, (snapshot) => {
                const engineers = [];
                allEngineersMap = {}; // Clear cache

                snapshot.docs.forEach(doc => {
                    const eng = { id: doc.id, ...doc.data() };
                    engineers.push(eng);
                    allEngineersMap[eng.id] = eng; // Update cache
                });

                renderEngineers(engineers);
            }, (error) => {
                console.error("Error listening to engineers collection: ", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÙŠØ§ÙØª Ù„Ø­Ø¸Ù‡â€ŒØ§ÙŠ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†.", 'error');
            });
            
            // 2. Real-time listener for Projects (for reports and future features)
            onSnapshot(PROJECTS_COLLECTION, (snapshot) => {
                allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Note: The projects are now cached in `allProjects` for reporting.
            }, (error) => {
                console.error("Error listening to projects collection: ", error);
                // Not critical, so only log error
            });
        }
        
        // Main Init Function
        async function init() {
            initializeAppReferences();
            
            // 1. Anonymous Authentication for simplicity (can be upgraded to a secure method later)
            try {
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        showMessage("Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³ÙŠØ³ØªÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯. Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ø§Ø± Ù‡Ø³ØªÙŠØ¯.", 'info');
                        setupRealtimeListeners(); // Start listening after successful login
                        showView('dashboardView'); // Show main view
                    } else {
                        userId = null;
                        isAuthReady = false;
                        showMessage("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÙŠØ³ØªÙ…. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÙŠ Ú©Ù†ÙŠØ¯.", 'error');
                    }
                });

            } catch (error) {
                console.error("Firebase Anonymous Sign-In failed:", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ù†Ø§Ø´Ù†Ø§Ø³ ÙØ§ÙŠØ±Ø¨ÙŠØ³. Ø¨Ø±Ø±Ø³ÙŠ Ú©Ù†Ø³ÙˆÙ„.", 'error');
            }
        }

        init();
        
    </script>
</body>
</html>
