<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // âŒ ØªØ§Ø¨Ø¹ signInAnonymously Ø­Ø°Ù Ø´Ø¯!
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, runTransaction, query, where, getDocs, increment, writeBatch, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // CONFIG OBJECT
    const firebaseConfig = { // Ù†Ø§Ù…â€ŒÚ¯Ø°Ø§Ø±ÙŠ Ø¨Ø±Ø§ÙŠ ÙˆØ¶ÙˆØ­ Ø¨Ù‡ØªØ±
        apiKey: "AIzaSyChV9mCptF4qybDn_yaOhmSz-KI3LhtDEQ",
        authDomain: "database-erjakar.firebaseapp.com",
        projectId: "database-erjakar",
        storageBucket: "database-erjakar.firebasestorage.app",
        messagingSenderId: "1056379437698",
        appId: "1:1056379437698:web:2a6bffc8ea0f1949436a9b",
        measurementId: "G-NS5ZPEFXD8"
    };
    
    // ØªÙ†Ø¸ÙŠÙ…Ø§Øª Ø³Ø±Ø§Ø³Ø±ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
    let app, db, auth, userId = null;
    let isAuthReady = false;
    
    // --- Static Data ---

    // Ù…Ø¨Ø§Ù„Øº Ù¾ÙŠØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÙŠ Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ø± (Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)
    const PROJECT_COSTS = {
        'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': 1,
        'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': 2,
        'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': 4, 
    };
    
    // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÙŠ Ù…Ø¯ÙŠØ±ÙŠØª ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ Ù…ØªØºÙŠØ±
    const JOB_DETAILS = {
        'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
        'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ú©Ù„ Ø²ÙŠØ± Ø¨Ù†Ø§ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
        'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' }, 
    };

    // Ø³Ù‚Ù Ø³Ù‡Ù…ÙŠÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÙŠÙ‡ (Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)
    const RANK_QUOTAS = {
        'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 10,
        'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 15,
        'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 20,
    };
    
    // Ø§ÙˆÙ„ÙˆÙŠØª Ø¹Ø¯Ø¯ÙŠ Ù¾Ø§ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø±Ø§ÙŠ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÙŠ (Ø¨ÙŠØ´ØªØ± = Ø§ÙˆÙ„ÙˆÙŠØª Ø¨Ø§Ù„Ø§ØªØ±)
    const RANK_PRIORITY = {
        'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 3,
        'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 2,
        'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 1,
    };

    // Ø§Ø±Ú¯Ø§Ù†â€ŒÙ‡Ø§ÙŠ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø¨Ø±Ø§ÙŠ Ù†Ù‚Ø´Ù‡â€ŒÙ‡Ø§ÙŠ UTM
    const UTM_ORGANIZATIONS = [
        'Ø§ÙˆÙ‚Ø§Ù Ùˆ Ø§Ù…ÙˆØ±Ø®ÙŠØ±ÙŠÙ‡',
        'Ø¨Ù†ÙŠØ§Ø¯ Ù…Ø³Ú©Ù†',
        'Ø¬Ù‡Ø§Ø¯ Ú©Ø´Ø§ÙˆØ±Ø²ÙŠ',
        'Ù…Ù†Ø§Ø¨Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ',
        'Ø§Ø¯Ø§Ø±Ù‡ Ø«Ø¨Øª Ø§Ø³Ù†Ø§Ø¯ Ùˆ Ø§Ù…Ù„Ø§Ú©',
        'Ù…ÙŠØ±Ø§Ø« ÙØ±Ù‡Ù†Ú¯ÙŠ',
        'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' 
    ];
    
    // Ù…Ø³ÙŠØ±Ù‡Ø§ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
    let ENGINEER_COLLECTION, PROJECTS_COLLECTION;
    let allEngineersMap = {}; // Cache for engineer details
    let allProjects = []; // Cache for all projects (used in reporting)

    // Ù…Ø±Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± Modal
    let detailsModalRef, modalTitleRef, projectsListRef, modalLoadingMessageRef;
    
    
    // ====================================================================
    // === CORE FIREBASE INITIALIZATION & AUTHENTICATION (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ===
    // ====================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
        // Populate Job Type dropdown on load
        const jobTypeSelect = document.getElementById('jobType');
        Object.keys(PROJECT_COSTS).forEach(jobType => {
            const option = document.createElement('option');
            option.value = jobType;
            option.textContent = jobType;
            jobTypeSelect.appendChild(option);
        });
        
        // Initial element references
        detailsModalRef = document.getElementById('detailsModal');
        modalTitleRef = document.getElementById('modalTitle');
        projectsListRef = document.getElementById('projectsList');
        modalLoadingMessageRef = document.getElementById('modalLoadingMessage');

        // Start Firebase setup
        initializeFirebase();
    });


    function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // --- Start Authentication ---
            // onAuthStateChanged ØªØ¶Ù…ÙŠÙ† Ù…ÙŠâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ú©Ø¯Ù‡Ø§ÙŠ Ø¯ÙŠØªØ§Ø¨ÙŠØ³ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ Ø§Ø¬Ø±Ø§ Ø´ÙˆÙ†Ø¯
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ (Ø¨Ø§ Ø¬ÙŠÙ…ÙŠÙ„ÙŠ Ú©Ù‡ Ø§Ø¯Ù…ÙŠÙ† Ø§Ø³Øª)
                    userId = user.uid;
                    isAuthReady = true;
                    showMessage(`Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. UID: ${userId.substring(0, 8)}...`, 'success');
                    
                    // ØªØ¹Ø±ÙŠÙ Ù…Ø±Ø§Ø¬Ø¹ Ú©Ø§Ù„Ú©Ø´Ù†â€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø¨ÙˆØ¯Ù† UID
                    ENGINEER_COLLECTION = collection(db, 'engineers');
                    PROJECTS_COLLECTION = collection(db, 'projects');

                    // Ø´Ø±ÙˆØ¹ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú©Ø§Ù„Ú©Ø´Ù†â€ŒÙ‡Ø§ (Ø®ÙˆØ§Ù†Ø¯Ù†)
                    startRealtimeListeners();
                    
                } else {
                    // Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†ÙŠØ³Øª. (Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯/Ø®Ø·Ø§ Ù‡Ø¯Ø§ÙŠØª Ø´ÙˆØ¯)
                    showMessage('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø­Ø³Ø§Ø¨ Ø§Ø¯Ù…ÙŠÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÙŠØ¯.', 'error');
                    // ğŸš¨ Ø§Ú¯Ø± Ø§ÙŠÙ† ØµÙØ­Ù‡ Ù†ÙŠØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø¬Ø¨Ø§Ø±ÙŠ Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ÙŠØ¯ Ø¨Ù‡ ØµÙØ­Ù‡ login.html Ù‡Ø¯Ø§ÙŠØª Ø´ÙˆØ¯.
                    // window.location.href = '/login.html'; // Ø§ÙŠÙ† Ø®Ø· Ø±Ø§ Ø§Ú¯Ø± ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø±ÙŠØ¯ØŒ ÙØ¹Ø§Ù„ Ú©Ù†ÙŠØ¯.
                }
            });

        } catch (e) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³:", e);
            showMessage('Ø®Ø·Ø§: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
        }
    }
    
    // ====================================================================
    // === REALTIME LISTENERS (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ===
    // ====================================================================

    function startRealtimeListeners() {
        if (!isAuthReady || !userId) return;

        // 1. Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú©Ø§Ù„Ú©Ø´Ù† Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†
        // Query: ÙÙ‚Ø· Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÙŠ
        const engineersQuery = query(ENGINEER_COLLECTION, where("userId", "==", userId));

        onSnapshot(engineersQuery, (querySnapshot) => {
            const engineers = [];
            document.getElementById('loadingMessage').classList.add('hidden'); // Ù¾ÙŠØºØ§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø±Ø§ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù†ÙŠØ¯
            document.getElementById('newQuotaButtonContainer').classList.remove('hidden'); // Ø¯Ú©Ù…Ù‡ ØªØ³ÙˆÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¯Ù‡ÙŠØ¯
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // Ø°Ø®ÙŠØ±Ù‡ Ø¯Ø± Ù†Ù‚Ø´Ù‡ (Map) Ø¨Ø±Ø§ÙŠ Ø¯Ø³ØªØ±Ø³ÙŠ Ø¢Ø³Ø§Ù† ØªÙˆØ³Ø· ID
                allEngineersMap[doc.id] = { id: doc.id, ...data };
                engineers.push({ id: doc.id, ...data });
            });
            renderEngineers(engineers);
        }, (error) => {
            console.error("Error listening to engineers collection: ", error);
            showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†: " + error.message, 'error');
        });
        
        // 2. Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú©Ø§Ù„Ú©Ø´Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ (ÙÙ‚Ø· Ø¨Ø±Ø§ÙŠ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÙŠØ±ÙŠ)
        // Query: ÙÙ‚Ø· Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÙŠ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÙŠ
        const projectsQuery = query(PROJECTS_COLLECTION, where("userId", "==", userId));

        onSnapshot(projectsQuery, (querySnapshot) => {
            allProjects = []; // Clear old cache
            querySnapshot.forEach((doc) => {
                allProjects.push({ id: doc.id, ...doc.data() });
            });
        }, (error) => {
            console.error("Error listening to projects collection: ", error);
            showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§: " + error.message, 'error');
        });
    }


    // ====================================================================
    // === CORE LOGIC (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ===
    // ====================================================================

    // ØªØ§Ø¨Ø¹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø¯Ø± Ø§ÙŠÙ† Ø¨Ø®Ø´)
    async function addEngineer(e) {
        e.preventDefault();
        
        if (!isAuthReady || !userId) {
            showMessage("Ø®Ø·Ø§: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø±ÙŠÙØ±Ø´ Ú©Ù†ÙŠØ¯.", 'error');
            return;
        }

        const fullName = document.getElementById('engineerName').value;
        const rank = document.getElementById('engineerRank').value;

        try {
            const newEngineer = {
                fullName,
                rank,
                maxQuota: RANK_QUOTAS[rank], // Ø³Ù‡Ù…ÙŠÙ‡ Ø§ÙˆÙ„ÙŠÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÙŠÙ‡
                usedQuota: 0, // Ø´Ø±ÙˆØ¹ Ø¨Ø§ Ø³Ù‡Ù…ÙŠÙ‡ Ù…ØµØ±ÙÙŠ ØµÙØ±
                // --- **ÙÙŠÙ„Ø¯ Ø­ÙŠØ§ØªÙŠ Ø¨Ø±Ø§ÙŠ Ø§Ù…Ù†ÙŠØª Ùˆ Ù‚ÙˆØ§Ù†ÙŠÙ† Firestore** ---
                userId: userId, 
                // ----------------------------------------------------
                createdAt: serverTimestamp()
            };

            await addDoc(ENGINEER_COLLECTION, newEngineer);
            showMessage("Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø«Ø¨Øª Ø´Ø¯.", 'success');
            document.getElementById('addEngineerForm').reset();
            showView('dashboardView');

        } catch (error) {
            console.error("Error adding engineer: ", error);
            // Ù¾ÙŠØºØ§Ù… Ø®Ø·Ø§ Ø¯Ø± Ø§ÙŠÙ†Ø¬Ø§ Ù…ÙŠâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø¯Ù„ÙŠÙ„ Ù†Ù‚Øµ Ù…Ø¬ÙˆØ² (Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÙŠÙ† Ù†Ø¨Ø§Ø´Ø¯) Ø¨Ø§Ø´Ø¯
            showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯. (Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÙŠ)", 'error'); 
        }
    }
    
    // ØªØ§Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ùˆ Ù…Ø¹Ø±ÙÙŠ Ù…Ù‡Ù†Ø¯Ø³ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø¯Ø± Ø§ÙŠÙ† Ø¨Ø®Ø´)
    async function assignProject(e) {
        e.preventDefault();
        
        if (!isAuthReady || !userId) {
            showMessage("Ø®Ø·Ø§: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø±ÙŠÙØ±Ø´ Ú©Ù†ÙŠØ¯.", 'error');
            return;
        }

        const jobType = document.getElementById('jobType').value;
        const clientName = document.getElementById('clientName').value;
        const projectAreaEl = document.getElementById('projectArea');
        const manualCostEl = document.getElementById('manualCost');
        const relatedOrganizationEl = document.getElementById('relatedOrganization');
        
        // Check for required fields
        if (!jobType || !clientName || !manualCostEl || !manualCostEl.value) {
            showMessage("Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ Ø¶Ø±ÙˆØ±ÙŠ Ø±Ø§ Ù¾Ø± Ú©Ù†ÙŠØ¯.", 'error');
            return;
        }

        const jobDetail = JOB_DETAILS[jobType];
        const area = projectAreaEl ? parseFloat(projectAreaEl.value) : 0;
        const cost = parseFloat(manualCostEl.value); // Ù‡Ø²ÙŠÙ†Ù‡ Ù†Ù‡Ø§ÙŠÙŠ Ø¨Ù‡ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†
        
        let organization;
        if (jobDetail.organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
            organization = relatedOrganizationEl ? relatedOrganizationEl.value : '';
            if (!organization) {
                showMessage("Ù„Ø·ÙØ§Ù‹ Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø¨Ø±Ø§ÙŠ Ù†Ù‚Ø´Ù‡ UTM Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯.", 'error');
                return;
            }
        } else {
            organization = jobDetail.organization;
        }

        // 1. ÙŠØ§ÙØªÙ† Ø¨Ù‡ØªØ±ÙŠÙ† Ù…Ù‡Ù†Ø¯Ø³
        // Ø§Ø² Ù„ÙŠØ³Øª Ú©Ø´ Ø´Ø¯Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÙŠØ¯.
        const availableEngineers = Object.values(allEngineersMap).filter(eng => {
            const remaining = eng.maxQuota - eng.usedQuota;
            return remaining >= cost; // Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÙŠ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        });

        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÙŠ: Ù¾Ø§ÙŠÙ‡ Ø¨Ø§Ù„Ø§ØªØ± + Ø¨ÙŠØ´ØªØ±ÙŠÙ† Ø³Ù‡Ù…ÙŠÙ‡ Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡
        const sortedAvailableEngineers = availableEngineers.sort((a, b) => {
            const rankA = RANK_PRIORITY[a.rank] || 0;
            const rankB = RANK_PRIORITY[b.rank] || 0;
            if (rankB !== rankA) {
                return rankB - rankA;
            }
            const remainingA = a.maxQuota - a.usedQuota;
            const remainingB = b.maxQuota - b.usedQuota;
            return remainingB - remainingA;
        });

        const assignedEngineer = sortedAvailableEngineers[0];

        const resultDiv = document.getElementById('assignmentResult');
        const resultText = document.getElementById('resultText');

        if (!assignedEngineer) {
            resultText.textContent = `Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø§ Ø³Ù‡Ù…ÙŠÙ‡ Ø¢Ø²Ø§Ø¯ Ú©Ø§ÙÙŠ (${formatCost(cost)} Ù…ÙˆØ±Ø¯ Ù†ÙŠØ§Ø²) ÙŠØ§ÙØª Ù†Ø´Ø¯.`;
            resultDiv.classList.remove('hidden');
            resultDiv.classList.add('border-red-400');
            resultDiv.classList.remove('border-blue-400');
            showMessage("Ø®Ø·Ø§: Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ú©Ø§ÙÙŠ Ù†ÙŠØ³Øª.", 'error');
            return;
        }
        
        // 2. Ø§Ù†Ø¬Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´ (Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÙŠ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ + Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡)
        try {
            await runTransaction(db, async (transaction) => {
                
                // A. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÙŠ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³
                const engineerRef = doc(ENGINEER_COLLECTION, assignedEngineer.id);
                const engineerDoc = await transaction.get(engineerRef);

                if (!engineerDoc.exists()) {
                    throw new Error("Ø³Ù†Ø¯ Ù…Ù‡Ù†Ø¯Ø³ ÙŠØ§ÙØª Ù†Ø´Ø¯.");
                }
                
                // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÙŠ ÙÙŠÙ„Ø¯ usedQuota
                const newUsedQuota = engineerDoc.data().usedQuota + cost;
                transaction.update(engineerRef, { 
                    usedQuota: newUsedQuota
                });
                
                // B. Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÙŠØ¯
                const newProject = {
                    engineerId: assignedEngineer.id,
                    engineerName: assignedEngineer.fullName,
                    jobType: jobType,
                    clientName: clientName,
                    area: area,
                    cost: cost,
                    organization: organization,
                    // --- **ÙÙŠÙ„Ø¯ Ø­ÙŠØ§ØªÙŠ Ø¨Ø±Ø§ÙŠ Ø§Ù…Ù†ÙŠØª Ùˆ Ù‚ÙˆØ§Ù†ÙŠÙ† Firestore** ---
                    userId: userId, 
                    // ----------------------------------------------------
                    assignedAt: serverTimestamp()
                };

                transaction.set(doc(PROJECTS_COLLECTION), newProject);
            });

            // Success
            resultText.innerHTML = `Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø¨Ù‡ <span class="text-green-700 font-bold">${assignedEngineer.fullName}</span> (Ù¾Ø§ÙŠÙ‡ ${assignedEngineer.rank}) Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯. <br>Ù‡Ø²ÙŠÙ†Ù‡: ${formatCost(cost)}`;
            resultDiv.classList.remove('hidden');
            resultDiv.classList.add('border-blue-400');
            resultDiv.classList.remove('border-red-400');
            showMessage("Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.", 'success');
            document.getElementById('assignProjectForm').reset();
            renderDynamicInputs(''); // Reset dynamic inputs

        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± (ØªØ±Ø§Ú©Ù†Ø´): ", error);
            showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯. (ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚)", 'error');
            // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ù†ØªÙŠØ¬Ù‡ Ø®Ø·Ø§
            resultText.innerHTML = `Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´: ${error.message}`;
            resultDiv.classList.remove('hidden');
            resultDiv.classList.add('border-red-400');
            resultDiv.classList.remove('border-blue-400');
        }
    }

    // ====================================================================
    // === EVENT HANDLERS ===
    // ====================================================================

    document.getElementById('addEngineerForm').addEventListener('submit', addEngineer);
    document.getElementById('assignProjectForm').addEventListener('submit', assignProject);
    
    // ØªØ§Ø¨Ø¹â€ŒÙ‡Ø§ÙŠ Ú©Ù…Ú©ÙŠ Ù†Ù…Ø§ÙŠØ´/Ù¾Ù†Ù‡Ø§Ù†â€ŒØ³Ø§Ø²ÙŠ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ (Ø¨Ø®Ø´â€ŒÙ‡Ø§ÙŠ Ø¸Ø§Ù‡Ø±ÙŠ)

    function showView(viewId) {
        // ... (Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø¯ÙŠØ¯Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÙŠ HTML) ...
        const views = document.querySelectorAll('.view-container > div');
        views.forEach(view => {
            if (view.id === viewId) {
                view.classList.remove('hidden-view');
                if (viewId === 'dashboardView') {
                    // Ø§Ø·Ù…ÙŠÙ†Ø§Ù† Ø§Ø² Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÙŠ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                    // Ú†ÙˆÙ† Ø§Ø² onSnapshot Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÙŠâ€ŒÚ©Ù†ÙŠÙ…ØŒ Ù†ÙŠØ§Ø² Ø¨Ù‡ ÙØ±Ø§Ø®ÙˆØ§Ù†ÙŠ Ù…Ø¬Ø¯Ø¯ Ù†ÙŠØ³Øª.
                }
            } else {
                view.classList.add('hidden-view');
            }
        });
        
        // Ø¯Ø± Ø´Ø±ÙˆØ¹ØŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¯Ù‡ÙŠØ¯
        if (viewId === 'assignProjectModal') {
            renderDynamicInputs(document.getElementById('jobType').value);
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        document.getElementById(modalId).classList.remove('flex');
    }

    // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÙŠ Ù†Ù…Ø§ÙŠØ´ Ù¾ÙŠØºØ§Ù…â€ŒÙ‡Ø§ÙŠ Toast
    let messageTimeout;
    function showMessage(message, type = 'info') {
        const box = document.getElementById('messageBox');
        box.textContent = message;
        box.classList.remove('hidden', 'bg-red-200', 'bg-green-200', 'bg-yellow-200', 'text-red-800', 'text-green-800', 'text-yellow-800');

        switch(type) {
            case 'success':
                box.classList.add('bg-green-200', 'text-green-800');
                break;
            case 'error':
                box.classList.add('bg-red-200', 'text-red-800');
                break;
            case 'info':
            default:
                box.classList.add('bg-yellow-200', 'text-yellow-800');
                break;
        }
        
        clearTimeout(messageTimeout);
        box.classList.add('flex', 'items-center', 'justify-center');
        messageTimeout = setTimeout(() => {
            box.classList.add('hidden');
            box.classList.remove('flex', 'items-center', 'justify-center');
        }, 5000);
    }

    // ØªØ§Ø¨Ø¹ ÙØ±Ù…Øª Ù‡Ø²ÙŠÙ†Ù‡ Ø¨Ù‡ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†
    function formatCost(cost) {
        return new Intl.NumberFormat('fa-IR', { style: 'currency', currency: 'IRR', minimumFractionDigits: 0 }).format(cost * 1000000).replace('Ø±ÙŠØ§Ù„', 'Ù….Øª');
    }
    
    // ... Ø§Ø¯Ø§Ù…Ù‡ ØªÙˆØ§Ø¨Ø¹ Ùˆ Ù…Ù†Ø·Ù‚ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÙŠ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÙŠØ±ÙŠ

    // ====================================================================
    // === DYNAMIC INPUTS LOGIC ===
    // ====================================================================
    
    document.getElementById('jobType').addEventListener('change', (e) => {
        renderDynamicInputs(e.target.value);
        document.getElementById('assignmentResult').classList.add('hidden'); // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù†ØªÙŠØ¬Ù‡ Ù‚Ø¨Ù„ÙŠ
    });

    function renderDynamicInputs(jobType) {
        const container = document.getElementById('dynamicInputs');
        container.innerHTML = ''; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ±ÙˆØ¯ÙŠâ€ŒÙ‡Ø§ÙŠ Ù‚Ø¨Ù„ÙŠ

        if (!jobType) {
            container.innerHTML = '<p class="text-sm text-gray-500 text-center">Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯ ØªØ§ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.</p>';
            return;
        }

        const detail = JOB_DETAILS[jobType];
        
        // 1. ÙÙŠÙ„Ø¯ Ù…ØªØ±Ø§Ú˜ (Area) - Ø¯Ø± ØµÙˆØ±Øª Ù†ÙŠØ§Ø²
        if (detail.isAreaRequired) {
            const areaHtml = `
                <div>
                    <label for="projectArea" class="block text-sm font-medium text-gray-700 mb-1">${detail.label}</label>
                    <input type="number" id="projectArea" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ÙÙ‚Ø· Ø¹Ø¯Ø¯ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', areaHtml);
        }
        
        // 2. ÙÙŠÙ„Ø¯ Ø§Ø±Ú¯Ø§Ù† (Organization) - ÙÙ‚Ø· Ø¨Ø±Ø§ÙŠ UTM
        if (jobType === 'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…' && detail.organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
            const orgOptions = UTM_ORGANIZATIONS.map(org => `<option value="${org}">${org}</option>`).join('');
            const orgHtml = `
                <div>
                    <label for="relatedOrganization" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡:</label>
                    <select id="relatedOrganization" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†...</option>
                        ${orgOptions}
                    </select>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', orgHtml);
        }

        // 3. ÙÙŠÙ„Ø¯ Ù‡Ø²ÙŠÙ†Ù‡ Ù†Ù‡Ø§ÙŠÙŠ (Manual Cost) - Ø«Ø§Ø¨Øª Ùˆ Ø§Ø¬Ø¨Ø§Ø±ÙŠ
        const costHtml = `
            <div>
                <label for="manualCost" class="block text-sm font-medium text-gray-700 mb-1">Ù‡Ø²ÙŠÙ†Ù‡ Ù†Ù‡Ø§ÙŠÙŠ Ú©Ø§Ø± (Ø¨Ù‡ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†):</label>
                <input type="number" id="manualCost" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: 4">
                <p class="text-xs text-gray-500 mt-1">Ù‡Ø²ÙŠÙ†Ù‡ Ø§ÙˆÙ„ÙŠÙ‡ Ù¾ÙŠØ´Ù†Ù‡Ø§Ø¯ÙŠ: ${formatCost(PROJECT_COSTS[jobType])}</p>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', costHtml);

        container.classList.remove('bg-gray-50');
    }

    // ====================================================================
    // === DASHBOARD RENDERING ===
    // ====================================================================
    
    function renderEngineers(engineers) {
        const listDiv = document.getElementById('engineerList');
        listDiv.innerHTML = '';
        
        if (engineers.length === 0) {
            listDiv.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">ØªØ§Ú©Ù†ÙˆÙ† Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
            return;
        }

        engineers.forEach(engineer => {
            const max = engineer.maxQuota || 0;
            const used = engineer.usedQuota || 0;
            const remaining = max - used;
            const percentage = max > 0 ? (used / max) * 100 : 0;
            
            const itemHtml = `
                <div class="p-4 border rounded-xl bg-gray-50 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div class="mb-3 md:mb-0">
                        <h4 class="text-lg font-bold text-gray-800">${engineer.fullName} <span class="text-blue-600 font-normal text-sm">(${engineer.rank})</span></h4>
                        <p class="text-sm text-gray-600">Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ù„: ${formatCost(max)} | Ø³Ù‡Ù…ÙŠÙ‡ Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡: <span class="font-semibold ${remaining < 0 ? 'text-red-600' : 'text-green-600'}">${formatCost(remaining)}</span></p>
                        ${remaining < 0 ? '<p class="text-xs text-red-600 font-bold mt-1">Ø¨Ø¯Ù‡ÙŠ Ø¨Ù‡ Ù…Ø¨Ù„Øº ' + formatCost(Math.abs(remaining)) + ' Ø¯Ø§Ø±ÙŠØ¯.</p>' : ''}
                    </div>

                    <div class="w-full md:w-1/2 md:ml-4">
                        <div class="flex justify-between mb-1 text-sm">
                            <span class="font-medium text-gray-700">Ø³Ù‡Ù…ÙŠÙ‡ Ù…ØµØ±ÙÙŠ (${percentage.toFixed(1)}%)</span>
                            <span class="font-medium text-gray-700">${formatCost(used)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="progress-bar-fill h-2.5 rounded-full ${percentage > 100 ? 'bg-red-600' : 'bg-blue-600'}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>

                    <div class="flex mt-3 md:mt-0 gap-2 flex-shrink-0">
                        <button onclick="showEngineerDetails('${engineer.id}', '${engineer.fullName}')" class="bg-gray-200 text-gray-700 p-2 text-sm rounded-lg hover:bg-gray-300 transition">
                            Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§
                        </button>
                        <button onclick="confirmResetQuota('${engineer.id}', '${engineer.fullName}', ${max})" class="bg-red-500 text-white p-2 text-sm rounded-lg hover:bg-red-600 transition disabled:opacity-50" ${remaining >= 0 ? 'disabled' : ''}>
                            ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ùˆ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡
                        </button>
                    </div>
                </div>
            `;
            listDiv.insertAdjacentHTML('beforeend', itemHtml);
        });
    }

    // ====================================================================
    // === MODAL AND CONFIRMATION LOGIC ===
    // ====================================================================
    
    // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÙŠØ´ Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÙŠÙŠØ¯ (Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡)
    function confirmResetQuota(engineerId, engineerName, maxQuota) {
        const modal = document.getElementById('confirmationModal');
        const title = document.getElementById('confirmModalTitle');
        const message = document.getElementById('confirmModalMessage');
        const acceptBtn = document.getElementById('confirmAcceptBtn');
        
        title.textContent = "ØªØ³ÙˆÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ùˆ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡";
        message.innerHTML = `Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ø³Ù‡Ù…ÙŠÙ‡ **${engineerName}** ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ (Ø¨Ù‡ Ù…ÙŠØ²Ø§Ù† ${formatCost(maxQuota)}) Ø¨Ø±Ø§ÙŠ Ø§Ùˆ Ø¨Ø§Ø² Ø´ÙˆØ¯ØŸ <br> Ø§ÙŠÙ† Ø¹Ù…Ù„ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª ØªØ³ÙˆÙŠÙ‡ Ú©Ø§Ù…Ù„ Ø¨Ø¯Ù‡ÙŠ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.`;
        
        // Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ÙŠ Ùˆ Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯
        acceptBtn.onclick = () => resetEngineerQuota(engineerId, maxQuota);
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    // ØªØ§Ø¨Ø¹ Ø±ÙŠØ³Øª Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡ ÙŠÚ© Ù…Ù‡Ù†Ø¯Ø³
    async function resetEngineerQuota(engineerId, maxQuota) {
        closeModal('confirmationModal');
        
        if (!isAuthReady || !userId) {
            showMessage("Ø®Ø·Ø§: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.", 'error');
            return;
        }

        try {
            const engineerRef = doc(ENGINEER_COLLECTION, engineerId);
            await updateDoc(engineerRef, {
                usedQuota: 0,
                maxQuota: maxQuota // Ø§Ø·Ù…ÙŠÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ù‚Ù Ù…Ø¬Ø§Ø²
            });
            showMessage("Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø¨Ø§Ø² Ø´Ø¯.", 'success');
        } catch (error) {
            console.error("Error resetting quota: ", error);
            showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯. (Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÙŠ)", 'error');
        }
    }
    
    // ØªØ§Ø¨Ø¹ Ø±ÙŠØ³Øª Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡ Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† (ÙÙ‚Ø· Ø§Ø¯Ù…ÙŠÙ†)
    async function resetAllEngineersQuotas() {
        if (!isAuthReady || !userId) {
            showMessage("Ø®Ø·Ø§: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.", 'error');
            return;
        }
        
        // ğŸš¨ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÙŠÙŠØ¯ Ø¨Ø±Ø§ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ù¾Ø±Ø®Ø·Ø±!
        const confirmationModal = document.getElementById('confirmationModal');
        const title = document.getElementById('confirmModalTitle');
        const message = document.getElementById('confirmModalMessage');
        const acceptBtn = document.getElementById('confirmAcceptBtn');
        
        title.textContent = "ØªØ³ÙˆÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙˆÙ…ÙŠ";
        message.innerHTML = `Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ù…ÙŠâ€ŒØ®ÙˆØ§Ù‡ÙŠØ¯ Ø³Ù‡Ù…ÙŠÙ‡ **Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†ÙŠ Ú©Ù‡ Ø¯Ø± Ø¨Ø¯Ù‡ÙŠ Ù‡Ø³ØªÙ†Ø¯** Ø±Ø§ ØµÙØ± Ú©Ù†ÙŠØ¯ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯Ù‡ÙŠØ¯ØŸ`;
        
        acceptBtn.onclick = async () => {
            closeModal('confirmationModal');
            try {
                const engineersInDebt = Object.values(allEngineersMap).filter(eng => (eng.maxQuota - eng.usedQuota) < 0);

                if (engineersInDebt.length === 0) {
                    showMessage("Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø±Ø§ÙŠ ØªØ³ÙˆÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ø¨Ø¯Ù‡ÙŠ Ù†Ø¯Ø§Ø±Ø¯.", 'info');
                    return;
                }

                const batch = writeBatch(db);
                engineersInDebt.forEach(engineer => {
                    const engineerRef = doc(ENGINEER_COLLECTION, engineer.id);
                    batch.update(engineerRef, {
                        usedQuota: 0,
                        maxQuota: RANK_QUOTAS[engineer.rank] || engineer.maxQuota
                    });
                });

                await batch.commit();
                showMessage(`ØªØ³ÙˆÙŠÙ‡ Ø­Ø³Ø§Ø¨ ${engineersInDebt.length} Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.`, 'success');

            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙˆÙ…ÙŠ: ", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙˆÙ…ÙŠ. (Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÙŠ)", 'error');
            }
        };
        
        confirmationModal.classList.remove('hidden');
        confirmationModal.classList.add('flex');
    }
    
    // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÙŠØ´ Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§ÙŠ Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ù‡ ÙŠÚ© Ù…Ù‡Ù†Ø¯Ø³ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÙŠ ÙÛŒÙ„ØªØ± userId)
    async function showEngineerDetails(engineerId, engineerName) {
        
        if (!isAuthReady || !userId) {
            showMessage("Ø®Ø·Ø§: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.", 'error');
            return;
        }
        
        const modal = detailsModalRef;
        const modalTitle = modalTitleRef;
        const projectsList = projectsListRef;
        const modalLoadingMessage = modalLoadingMessageRef;
        
        modal.classList.remove('hidden');
        modal.classList.add('flex'); // Ù†Ù…Ø§ÙŠØ´ Ù…ÙˆØ¯Ø§Ù„
        modalTitle.textContent = `Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§ÙŠ ${engineerName}`;
        projectsList.innerHTML = '';
        modalLoadingMessage.classList.remove('hidden');
        
        try {
            // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ø§Ù„Ú©Ø´Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ engineerId Ùˆ userId
            const q = query(PROJECTS_COLLECTION, 
                where("engineerId", "==", engineerId), 
                where("userId", "==", userId) // ÙÙŠÙ„ØªØ± Ø§Ù…Ù†ÙŠØªÙŠ: ÙÙ‚Ø· Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÙŠ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø§ÙŠÙ† Ú©Ø§Ø±Ø¨Ø±
            );

            const querySnapshot = await getDocs(q);
            
            modalLoadingMessage.classList.add('hidden');
            
            if (querySnapshot.empty) {
                projectsList.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">Ù‡ÙŠÚ† Ú©Ø§Ø±ÙŠ Ø¨Ø±Ø§ÙŠ Ø§ÙŠÙ† Ù…Ù‡Ù†Ø¯Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                return;
            }
            
            let totalCost = 0;
            let detailsHTML = '<div class="space-y-3">';
            
            querySnapshot.forEach(doc => {
                const project = doc.data();
                const date = project.assignedAt ? new Date(project.assignedAt.seconds * 1000).toLocaleDateString('fa-IR') : 'Ù†Ø§Ù…Ø´Ø®Øµ';
                totalCost += project.cost;

                detailsHTML += `
                    <div class="p-3 border rounded-lg bg-white shadow-sm">
                        <p class="font-bold text-gray-800">${project.jobType} (${formatCost(project.cost)})</p>
                        <p class="text-sm text-gray-600">Ù…ØªÙ‚Ø§Ø¶ÙŠ: ${project.clientName}</p>
                        <p class="text-xs text-gray-500">ØªØ§Ø±ÙŠØ®: ${date} | Ø§Ø±Ú¯Ø§Ù†: ${project.organization}</p>
                    </div>
                `;
            });
            
            detailsHTML += `</div>`; // Ø¨Ø³ØªÙ† div
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¬Ù…Ø¹ Ú©Ù„ Ø¯Ø± Ù¾Ø§ÙŠÙŠÙ† Ù„ÙŠØ³Øª
            const footerHtml = `
                <div class="mt-4 p-3 border-t-2 border-blue-200 bg-blue-50 rounded-lg">
                    <p class="font-bold text-lg text-blue-800">Ø¬Ù…Ø¹ Ú©Ù„ Ù‡Ø²ÙŠÙ†Ù‡â€ŒÙ‡Ø§: ${formatCost(totalCost)}</p>
                </div>
            `;

            projectsList.innerHTML = detailsHTML + footerHtml;

        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§:", error);
            modalLoadingMessage.classList.add('hidden');
            projectsList.innerHTML = `<p class="text-center text-red-600 p-4 bg-red-50 rounded-lg">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ: ${error.message}</p>`;
        }
    }
    
    // ====================================================================
    // === REPORTING LOGIC ===
    // ====================================================================

    function showMonthlyReport() {
        if (!isAuthReady || !userId) {
            showMessage("Ø®Ø·Ø§: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.", 'error');
            return;
        }
        
        const modal = document.getElementById('printReportModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        renderMonthlyReport();
    }
    
    function renderMonthlyReport() {
        const reportArea = document.getElementById('printReportArea');
        reportArea.innerHTML = '<div class="text-center p-8 text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÙŠ Ú¯Ø²Ø§Ø±Ø´...</div>';
        
        // Ø§ÙŠÙ†Ø¬Ø§ Ø§Ø² allProjects (Ú©Ø´ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· onSnapshot) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÙŠâ€ŒÚ©Ù†ÙŠÙ….
        const projects = allProjects; 
        
        if (projects.length === 0) {
            reportArea.innerHTML = '<div class="text-center p-8 text-gray-500">Ø¯Ø± Ù…Ø§Ù‡ Ø¬Ø§Ø±ÙŠ Ù‡ÙŠÚ† Ú©Ø§Ø±ÙŠ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
            return;
        }

        // 1. ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ (Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ)
        // Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ú¯ÛŒØ±ÛŒØ¯ ÛŒØ§ ÙÛŒÙ„ØªØ± Ø¨Ù‡ØªØ±ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.
        const currentMonthProjects = projects; // ÙØ¹Ù„Ø§Ù‹ Ù‡Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
        
        // 2. Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‡Ù†Ø¯Ø³
        const engineerReports = {};
        let totalProjectsCount = 0;
        let totalProjectsCost = 0;

        currentMonthProjects.forEach(p => {
            const engineerId = p.engineerId;
            const cost = p.cost;
            
            if (!engineerReports[engineerId]) {
                const engineerDetail = allEngineersMap[engineerId] || { fullName: 'Ù†Ø§Ù… Ù…Ù‡Ù†Ø¯Ø³ Ù†Ø§Ù…Ø´Ø®Øµ', rank: 'Ù†Ø§Ù…Ø´Ø®Øµ' };
                engineerReports[engineerId] = {
                    fullName: engineerDetail.fullName,
                    rank: engineerDetail.rank,
                    projects: [],
                    totalCost: 0,
                    projectCount: 0
                };
            }
            
            engineerReports[engineerId].projects.push(p);
            engineerReports[engineerId].totalCost += cost;
            engineerReports[engineerId].projectCount++;
            
            totalProjectsCount++;
            totalProjectsCost += cost;
        });
        
        // 3. Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ HTML
        let tableHtml = `
            <div class="print-only text-center my-4">
                <h1 class="text-2xl font-bold">Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ú©Ø§Ø±</h1>
                <p class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® ØªÙ‡ÙŠÙ‡ Ú¯Ø²Ø§Ø±Ø´: ${new Date().toLocaleDateString('fa-IR')}</p>
            </div>
            <table class="report-table">
                <thead>
                    <tr class="bg-blue-100 text-blue-900 font-semibold">
                        <th>Ù…Ù‡Ù†Ø¯Ø³</th>
                        <th>Ù¾Ø§ÙŠÙ‡</th>
                        <th>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±</th>
                        <th>Ø¬Ù…Ø¹ Ù‡Ø²ÙŠÙ†Ù‡â€ŒÙ‡Ø§</th>
                    </tr>
                </thead>
                <tbody>
        `;

        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬Ù…Ø¹ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
        const sortedEngineers = Object.values(engineerReports).sort((a, b) => b.totalCost - a.totalCost);

        sortedEngineers.forEach(report => {
            tableHtml += `
                <tr class="hover:bg-gray-50">
                    <td>${report.fullName}</td>
                    <td>${report.rank}</td>
                    <td class="text-center">${report.projectCount}</td>
                    <td class="font-bold">${formatCost(report.totalCost)}</td>
                </tr>
            `;
        });
        
        tableHtml += `
                </tbody>
                <tfoot>
                    <tr class="bg-gray-200 font-extrabold">
                        <td colspan="2" class="text-center">Ø¬Ù…Ø¹ Ú©Ù„</td>
                        <td class="text-center">${totalProjectsCount}</td>
                        <td>${formatCost(totalProjectsCost)}</td>
                    </tr>
                </tfoot>
            </table>
        `;
        
        reportArea.innerHTML = tableHtml;
    }
    
    // ØªØ§Ø¨Ø¹ Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´ (Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ú†Ø§Ù¾)
    window.printReport = () => {
        window.print();
    };
    
    // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    showView('dashboardView');
    
</script>
