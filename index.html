<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامه ساده فایربیس</title>
    <!-- بارگذاری Tailwind CSS برای استایل‌دهی زیبا و ریسپانسیو -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
        ** تضمین بارگذاری فونت Vazirmatn **
        این بخش برای اطمینان از نمایش صحیح کاراکترهای فارسی اضافه شده است.
        Vazirmatn یک فونت مدرن و خوانا برای زبان فارسی است.
        */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Vazirmatn:wght@100..900&display=swap');
        
        body {
            /* Vazirmatn به عنوان فونت اصلی برای پشتیبانی کامل از RTL */
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        /* مطمئن شدن از جهت متن راست به چپ برای کل رابط */
        #app, input, button {
            direction: rtl;
            text-align: right;
        }

        /* برای User ID، جهت متن را چپ به راست نگه می‌داریم تا کاراکترها و اعداد لاتین صحیح نمایش داده شوند */
        #display-user-id, #last-updated span {
            direction: ltr;
            text-align: left;
            unicode-bidi: embed; /* این کمک می‌کند که جهت‌گیری صحیح حفظ شود */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-xl mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-10 border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3 text-center">ذخیره داده در فایربیس</h1>
        
        <div id="auth-status" class="mb-4 text-center">
            <p class="text-sm text-gray-500">
                وضعیت اتصال: 
                <span id="loading-text" class="text-yellow-600 font-semibold">در حال اتصال...</span>
                <span id="connected-text" class="text-green-600 font-semibold hidden">متصل</span>
            </p>
        </div>

        <!-- نمایش User ID (اجباری برای برنامه‌های چندکاربره) -->
        <div id="user-info" class="mb-6 p-3 bg-gray-50 rounded-lg text-sm border border-gray-200">
            <p class="text-gray-600 font-medium">شناسه کاربری (User ID):</p>
            <code id="display-user-id" class="block w-full text-xs break-all mt-1 p-2 bg-white rounded text-gray-700">منتظر احراز هویت...</code>
            <p class="mt-2 text-xs text-gray-400">این شناسه برای ذخیره داده‌های خصوصی شما استفاده می‌شود.</p>
        </div>

        <!-- بخش ورودی پیام -->
        <div id="data-input-section" class="mb-8 p-5 bg-blue-50 rounded-xl shadow-inner hidden">
            <label for="message-input" class="block text-lg font-medium text-blue-800 mb-2">پیام خصوصی شما:</label>
            <input type="text" id="message-input" placeholder="اینجا یک پیام بنویسید..."
                   class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-right"
                   maxlength="100">
            <button id="save-button"
                    class="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-200 shadow-md hover:shadow-lg disabled:opacity-50">
                ذخیره پیام در Firestore
            </button>
        </div>

        <!-- بخش نمایش داده -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">آخرین پیام ذخیره‌شده:</h2>
            <div id="data-output" class="p-5 bg-green-50 border-2 border-green-300 rounded-lg min-h-20 flex items-center justify-center text-right">
                <p id="current-message" class="text-xl text-green-800 italic">هنوز پیامی ذخیره نشده است.</p>
            </div>
            <p id="last-updated" class="text-xs text-gray-400 mt-2 text-left">آخرین به‌روزرسانی: <span dir="ltr">--</span></p>
        </div>

    </div>

    <!-- بارگذاری SDK های Firebase -->
    <script type="module">
        // ** ماژول‌های مورد نیاز Firebase **
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // تنظیم سطح لاگ به Debug برای دیدن جزئیات عملیات Firestore
        setLogLevel('Debug');
        
        // ** متغیرهای سراسری اجباری Canvas **
        // این متغیرها به صورت خودکار توسط محیط Canvas تزریق می‌شوند.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;

        // ** عناصر DOM **
        const messageInput = document.getElementById('message-input');
        const saveButton = document.getElementById('save-button');
        const displayUserId = document.getElementById('display-user-id');
        const currentMessage = document.getElementById('current-message');
        const lastUpdated = document.getElementById('last-updated');
        const dataInputSection = document.getElementById('data-input-section');
        const loadingText = document.getElementById('loading-text');
        const connectedText = document.getElementById('connected-text');


        // =========================================================================
        // 1. مقداردهی اولیه (Initialization)
        // =========================================================================
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("خطا در مقداردهی اولیه Firebase:", error);
            loadingText.textContent = 'خطا در مقداردهی اولیه';
            loadingText.classList.remove('text-yellow-600');
            loadingText.classList.add('text-red-600');
        }


        // =========================================================================
        // 2. احراز هویت (Authentication)
        // =========================================================================
        const authenticateUser = async () => {
            try {
                if (initialAuthToken) {
                    // استفاده از توکن سفارشی (روش ترجیحی در محیط Canvas)
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("ورود موفق با توکن سفارشی.");
                } else {
                    // ورود ناشناس (اگر توکن سفارشی در دسترس نبود)
                    await signInAnonymously(auth);
                    console.warn("ورود موفق ناشناس. لطفا __initial_auth_token را تنظیم کنید.");
                }
            } catch (error) {
                console.error("خطا در احراز هویت Firebase:", error);
                loadingText.textContent = 'خطا در احراز هویت';
                loadingText.classList.remove('text-yellow-600');
                loadingText.classList.add('text-red-600');
            }
        };

        // =========================================================================
        // 3. تنظیم شنونده وضعیت احراز هویت (Auth State Listener)
        // =========================================================================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // کاربر لاگین کرده است
                userId = user.uid;
                displayUserId.textContent = userId;
                loadingText.classList.add('hidden');
                connectedText.classList.remove('hidden');
                dataInputSection.classList.remove('hidden');
                
                // پس از احراز هویت، شنونده داده را فعال کنید
                setupRealtimeListener();
                
            } else {
                // کاربر لاگین نکرده است
                userId = null;
                displayUserId.textContent = 'کاربر احراز هویت نشده است.';
                dataInputSection.classList.add('hidden');
            }
        });


        // =========================================================================
        // 4. توابع هسته Firestore
        // =========================================================================

        /**
         * مسیر مرجع داکیومنت خصوصی کاربر را می‌سازد.
         * مسیر: /artifacts/{appId}/users/{userId}/messages/my_message
         */
        const getPrivateDocRef = (uid) => {
            // توجه: collectionName در این مثال 'messages' است.
            return doc(db, 'artifacts', appId, 'users', uid, 'messages', 'my_message');
        };

        /**
         * ذخیره پیام جدید در Firestore.
         */
        const saveMessage = async () => {
            if (!userId) {
                console.error("خطا: شناسه کاربری (userId) در دسترس نیست.");
                return;
            }
            if (messageInput.value.trim() === '') {
                // نمایش خطای سفارشی به جای alert()
                currentMessage.textContent = '!لطفاً یک پیام معتبر وارد کنید';
                currentMessage.classList.add('text-red-600');
                currentMessage.classList.remove('text-green-800');
                setTimeout(() => {
                    currentMessage.textContent = 'هنوز پیامی ذخیره نشده است.';
                    currentMessage.classList.remove('text-red-600');
                    currentMessage.classList.add('text-green-800');
                }, 3000);
                return;
            }

            const messageData = {
                message: messageInput.value.trim(),
                timestamp: new Date().toISOString()
            };

            const docRef = getPrivateDocRef(userId);

            saveButton.textContent = 'در حال ذخیره...';
            saveButton.disabled = true;

            try {
                // از setDoc برای ایجاد یا جایگزینی داکیومنت استفاده می‌کنیم
                await setDoc(docRef, messageData);
                console.log("پیام با موفقیت ذخیره شد.");
                messageInput.value = ''; // پاک کردن ورودی
            } catch (e) {
                console.error("خطا در ذخیره داده:", e);
                currentMessage.textContent = `خطا در ذخیره سازی: ${e.message}`;
                currentMessage.classList.add('text-red-600');
            } finally {
                saveButton.textContent = 'ذخیره پیام در Firestore';
                saveButton.disabled = false;
            }
        };

        /**
         * تنظیم شنونده بلادرنگ (Real-time listener) برای داده کاربر.
         */
        const setupRealtimeListener = () => {
            if (!userId) return;

            const docRef = getPrivateDocRef(userId);
            
            // onSnapshot برای گوش دادن به تغییرات بلادرنگ
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentMessage.textContent = data.message || 'پیامی وجود ندارد.';
                    currentMessage.classList.remove('italic');

                    const date = new Date(data.timestamp);
                    lastUpdated.querySelector('span').textContent = date.toLocaleString('fa-IR', {
                        year: 'numeric', month: 'numeric', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                } else {
                    currentMessage.textContent = 'هنوز پیامی ذخیره نشده است.';
                    currentMessage.classList.add('italic');
                    lastUpdated.querySelector('span').textContent = '--';
                }
            }, (error) => {
                console.error("خطا در گوش دادن بلادرنگ:", error);
                currentMessage.textContent = `خطا در بازیابی داده: ${error.message}`;
                currentMessage.classList.add('text-red-600');
            });
        };

        // =========================================================================
        // 5. اتصال رویدادها (Event Listeners) و شروع برنامه
        // =========================================================================

        saveButton.addEventListener('click', saveMessage);

        // شروع فرآیند احراز هویت هنگام بارگذاری صفحه
        window.onload = authenticateUser;

    </script>
</body>
</html>
